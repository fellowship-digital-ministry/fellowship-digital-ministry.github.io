---
layout: default
---

<div class="container">
  <div class="content-area">
    <h1>{{ page.title }}</h1>
    
    <div id="sermon-content">
      <!-- Will be populated by JavaScript -->
      <div class="sermon-loading">
        <p>Loading sermon content...</p>
        <div class="spinner"></div>
      </div>
    </div>
    
    <!-- Transcript section -->
    <div id="transcript-section" style="display: none;">
      <h2>Sermon Transcript</h2>
      <div class="transcript-controls">
        <button id="transcript-toggle" class="button secondary">Show Transcript</button>
      </div>
      <div id="transcript-viewer" class="transcript-viewer" style="display: none;">
        <div id="transcript-text" class="transcript-text"></div>
      </div>
    </div>
    
    <!-- Related sermons section -->
    <div id="related-sermons" style="display: none;">
      <h2>Related Sermons</h2>
      <div id="related-sermons-list" class="related-sermons-list"></div>
    </div>
  </div>
</div>

<script src="{{ '/assets/js/api-client.js' | relative_url }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get the video ID from the URL
    const pathParts = window.location.pathname.split('/');
    const videoId = pathParts[pathParts.length - 1].replace(/\/$/, '');
    
    // Get time parameter if present
    const urlParams = new URLSearchParams(window.location.search);
    const startTime = urlParams.get('t');
    
    // Elements
    const sermonContent = document.getElementById('sermon-content');
    const transcriptSection = document.getElementById('transcript-section');
    const transcriptToggle = document.getElementById('transcript-toggle');
    const transcriptViewer = document.getElementById('transcript-viewer');
    const transcriptText = document.getElementById('transcript-text');
    const relatedSermons = document.getElementById('related-sermons');
    const relatedSermonsList = document.getElementById('related-sermons-list');
    
    // Load sermon data
    loadSermonData(videoId);
    
    // Transcript toggle
    transcriptToggle.addEventListener('click', function() {
      const isVisible = transcriptViewer.style.display !== 'none';
      
      transcriptViewer.style.display = isVisible ? 'none' : 'block';
      transcriptToggle.textContent = isVisible ? 'Show Transcript' : 'Hide Transcript';
      
      // If showing transcript, scroll to it
      if (!isVisible) {
        transcriptViewer.scrollIntoView({ behavior: 'smooth' });
      }
    });
    
    // Load sermon data from API
    async function loadSermonData(videoId) {
      try {
        const sermon = await window.sermonApi.getSermon(videoId);
        
        if (!sermon || !sermon.sermon) {
          showError('Sermon not found.');
          return;
        }
        
        // Update page title if needed
        document.title = sermon.sermon.title + ' | Sermon Library';
        
        // Render sermon content
        renderSermonContent(sermon);
        
        // Show transcript section
        transcriptSection.style.display = 'block';
        
        // Render transcript
        renderTranscript(sermon.chunks);
        
        // Get related sermons (using a basic search for similar content)
        loadRelatedSermons(sermon.sermon.title);
        
        // If we have a time parameter, highlight that part of the transcript
        if (startTime) {
          highlightTranscriptAtTime(startTime);
        }
      } catch (error) {
        console.error('Error loading sermon:', error);
        showError('Error loading sermon data. Please try again later.');
      }
    }
    
    // Render sermon content
    function renderSermonContent(sermon) {
      const data = sermon.sermon;
      
      // Format date if available
      let dateDisplay = '';
      if (data.publish_date) {
        const date = new Date(data.publish_date);
        dateDisplay = `<div class="sermon-date">${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>`;
      }
      
      sermonContent.innerHTML = `
        <div class="sermon-player">
          <div class="video-container">
            <iframe 
              src="https://www.youtube.com/embed/${data.video_id}${startTime ? '?start=' + startTime : ''}" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen>
            </iframe>
          </div>
          
          <div class="sermon-meta">
            ${dateDisplay}
            <div class="sermon-channel">${data.channel}</div>
            <a href="${data.url}" target="_blank" class="youtube-link">Watch on YouTube</a>
          </div>
        </div>
      `;
    }
    
    // Render transcript
    function renderTranscript(chunks) {
      if (!chunks || chunks.length === 0) {
        transcriptText.innerHTML = '<p>Transcript not available for this sermon.</p>';
        return;
      }
      
      // Sort chunks by start time
      chunks.sort((a, b) => a.start_time - b.start_time);
      
      let transcriptHtml = '';
      
      chunks.forEach((chunk, index) => {
        const formattedStartTime = SermonApiClient.formatTime(chunk.start_time);
        
        transcriptHtml += `
          <div class="transcript-chunk" data-start-time="${chunk.start_time}" data-end-time="${chunk.end_time}" id="chunk-${index}">
            <span class="transcript-timestamp" data-time="${chunk.start_time}">[${formattedStartTime}]</span>
            <span class="transcript-text-content">${chunk.text}</span>
          </div>
        `;
      });
      
      transcriptText.innerHTML = transcriptHtml;
      
      // Add click handlers to timestamps
      document.querySelectorAll('.transcript-timestamp').forEach(timestamp => {
        timestamp.addEventListener('click', function() {
          const time = this.dataset.time;
          
          // Update video time
          const iframe = document.querySelector('.video-container iframe');
          if (iframe) {
            const newSrc = iframe.src.split('?')[0] + '?start=' + Math.floor(time);
            iframe.src = newSrc;
          }
          
          // Highlight the clicked section
          highlightTranscriptAtTime(time);
        });
      });
    }
    
    // Highlight transcript at specific time
    function highlightTranscriptAtTime(time) {
      // Remove any existing highlights
      document.querySelectorAll('.transcript-chunk').forEach(chunk => {
        chunk.classList.remove('highlight');
      });
      
      // Find the chunk that contains this time
      const targetTime = parseFloat(time);
      const chunks = document.querySelectorAll('.transcript-chunk');
      
      for (let i = 0; i < chunks.length; i++) {
        const chunk = chunks[i];
        const startTime = parseFloat(chunk.dataset.startTime);
        const endTime = parseFloat(chunk.dataset.endTime);
        
        if (targetTime >= startTime && targetTime <= endTime) {
          chunk.classList.add('highlight');
          
          // Scroll to this chunk
          transcriptViewer.style.display = 'block';
          transcriptToggle.textContent = 'Hide Transcript';
          chunk.scrollIntoView({ behavior: 'smooth', block: 'center' });
          break;
        }
      }
    }
    
    // Load related sermons
    async function loadRelatedSermons(title) {
      try {
        // Extract keywords from title (simple approach)
        const keywords = title
          .split(' ')
          .filter(word => word.length > 3) // Only words longer than 3 chars
          .slice(0, 3) // Take up to 3 words
          .join(' ');
        
        if (!keywords) return;
        
        const results = await window.sermonApi.search(keywords, { topK: 4, minScore: 0.5 });
        
        if (results.results && results.results.length > 0) {
          // Filter out the current sermon
          const filteredResults = results.results
            .filter(result => result.video_id !== videoId)
            // Get unique video IDs (one result per sermon)
            .filter((result, index, self) => 
              index === self.findIndex(r => r.video_id === result.video_id)
            )
            .slice(0, 3); // Limit to 3 related sermons
          
          if (filteredResults.length > 0) {
            renderRelatedSermons(filteredResults);
          }
        }
      } catch (error) {
        console.error('Error loading related sermons:', error);
        // Just hide the section on error
        relatedSermons.style.display = 'none';
      }
    }
    
    // Render related sermons
    function renderRelatedSermons(relatedSermonData) {
      relatedSermonsList.innerHTML = '';
      
      relatedSermonData.forEach(sermon => {
        const sermonElement = document.createElement('div');
        sermonElement.className = 'related-sermon-item';
        
        sermonElement.innerHTML = `
          <h3><a href="/sermons/${sermon.video_id}">${sermon.title}</a></h3>
          <a href="/sermons/${sermon.video_id}" class="button secondary small">View Sermon</a>
        `;
        
        relatedSermonsList.appendChild(sermonElement);
      });
      
      // Show the related sermons section
      relatedSermons.style.display = 'block';
    }
    
    // Show error message
    function showError(message) {
      sermonContent.innerHTML = `
        <div class="error-message">
          <p>${message}</p>
          <a href="/sermons/" class="button secondary">Back to Sermons</a>
        </div>
      `;
    }
  });
</script>