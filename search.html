---
layout: default
title: Chat about Sermons
hero_banner: true
hero_title: CHAT ABOUT SERMONS
hero_subtitle: EXPLORE BIBLICAL TEACHINGS
hero_description: Ask questions about sermon content and get AI-generated answers based on the sermon library.
quote_text: "Exalting our Saviour ~ Edifying the Believer ~ Evangelizing the World"
---

<div class="container">
  <!-- Page Introduction -->
  <div class="page-intro">
    <h2 class="content-section-header">Sermon Search Tool</h2>
    <p>This interactive tool uses AI to search through sermon transcripts and provide relevant answers to your questions about the pastor's teachings.</p>
  </div>

  <!-- Chat Interface -->
  <div class="chat-container">
    <div id="api-status-banner" style="display: none; background-color: #fef2f2; color: #b91c1c; padding: 8px 12px; text-align: center; font-size: 14px; border-bottom: 1px solid #eeeeee;">
      <span id="api-status-message">API connection issue detected. Check console for details.</span>
      <button id="retry-connection" style="margin-left: 10px; background: #b91c1c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Retry</button>
    </div>

    <div id="messages" class="messages">
      <div class="message bot">
        Welcome! Ask any question about the pastor's sermons, and I'll provide an answer based on the sermon content.
      </div>
    </div>
    
    <form id="chatForm" class="chat-form">
      <input type="text" id="queryInput" class="chat-input" placeholder="What does the pastor teach about faith?" required>
      <button type="submit" class="chat-button">Send</button>
    </form>
  </div>

  <!-- Help Section -->
  <div class="info-section">
    <h2 class="content-section-header">How to Use This Tool</h2>
    
    <div class="row">
      <div class="col-md-6">
        <div class="content-card">
          <h3>Sample Questions</h3>
          <p>Here are some examples of questions you can ask:</p>
          <ul class="example-questions">
            <li>"What does the pastor teach about prayer?"</li>
            <li>"How does the pastor interpret John 3:16?"</li>
            <li>"What are the pastor's views on forgiveness?"</li>
            <li>"Explain the sermon series on Revelation"</li>
            <li>"Find references to the Holy Spirit"</li>
          </ul>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="content-card">
          <h3>About This Tool</h3>
          <p>This search tool uses artificial intelligence to analyze sermon transcripts and provide relevant information.</p>
          <p>When you ask a question, the AI will:</p>
          <ul>
            <li>Search through the entire sermon library</li>
            <li>Find the most relevant content to your question</li>
            <li>Provide direct links to video timestamps</li>
            <li>Show you the exact context where information was found</li>
          </ul>
          <p>All answers are based solely on the pastor's actual sermon content.</p>
        </div>
      </div>
    </div>
    
    <div class="content-card">
      <h3>Tips for Better Results</h3>
      <div class="row">
        <div class="col-md-6">
          <ul>
            <li>Be specific in your questions</li>
            <li>Include Bible references if relevant</li>
            <li>Ask about specific topics or passages</li>
          </ul>
        </div>
        <div class="col-md-6">
          <ul>
            <li>Try reformulating if you don't get a helpful answer</li>
            <li>You can ask follow-up questions for clarification</li>
            <li>Check the video links to hear the full context</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Enhanced Styles for the Sermon Search Interface */

/* Chat container improvements */
.chat-container {
  max-width: 800px;
  margin: 2rem auto;
  border: 1px solid var(--color-border);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  height: 70vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background-color: white;
  transition: box-shadow 0.3s ease;
}

.chat-container:focus-within {
  box-shadow: 0 6px 24px rgba(46, 163, 242, 0.15);
}

/* Message styling improvements */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 1.25rem;
  background-color: #f8f9fa;
  scroll-behavior: smooth;
}

.message {
  max-width: 80%;
  margin-bottom: 1rem;
  padding: 0.9rem 1.1rem;
  border-radius: 1.2rem;
  position: relative;
  line-height: 1.5;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  word-wrap: break-word;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

/* Message animations */
.message-appear {
  animation: messageAppear 0.3s ease forwards;
}

.message-disappear {
  animation: messageDisappear 0.3s ease forwards;
}

@keyframes messageAppear {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes messageDisappear {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(10px);
  }
}

.message.user {
  background-color: var(--color-primary);
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 0.3rem;
}

.message.bot {
  background-color: white;
  margin-right: auto;
  border-bottom-left-radius: 0.3rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Welcome message special styling */
.welcome-message {
  width: 100%;
  max-width: 90%;
}

.welcome-message h4 {
  margin-top: 0;
  color: var(--color-primary);
  margin-bottom: 0.75rem;
}

.suggestion-heading {
  margin: 1rem 0 0.5rem;
  font-weight: 600;
  color: #555;
}

.suggestion-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.suggestion-chip {
  background-color: rgba(46, 163, 242, 0.1);
  color: var(--color-primary);
  border: 1px solid rgba(46, 163, 242, 0.2);
  padding: 0.5rem 0.75rem;
  border-radius: 100px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.suggestion-chip:hover {
  background-color: rgba(46, 163, 242, 0.2);
  transform: translateY(-2px);
}

/* Typing indicator */
.typing-indicator {
  min-width: 50px;
  max-width: 50px;
  border-radius: 1.2rem;
  padding: 0.6rem 1rem;
}

.typing-dots {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 26px;
}

.typing-dots .dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  margin: 0 2px;
  background-color: #aaa;
  border-radius: 50%;
  animation: typingAnimation 1.4s infinite ease-in-out both;
}

.typing-dots .dot:nth-child(1) {
  animation-delay: -0.32s;
}

.typing-dots .dot:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes typingAnimation {
  0%, 80%, 100% { 
    transform: scale(0.7);
    opacity: 0.6;
  }
  40% { 
    transform: scale(1);
    opacity: 1;
  }
}

/* Enhanced input area */
.chat-form {
  display: flex;
  padding: 1rem;
  border-top: 1px solid var(--color-border);
  background-color: white;
  align-items: center;
  transition: all 0.3s ease;
}

.chat-input {
  flex: 1;
  padding: 0.9rem 1rem;
  border: 1px solid #e0e5eb;
  border-radius: 8px;
  font: inherit;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05) inset;
}

.chat-input:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(46, 163, 242, 0.15);
  outline: none;
}

.chat-button {
  padding: 0.9rem 1.25rem;
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: 8px;
  margin-left: 0.75rem;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.chat-button:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

/* Sources display improvements */
.sources-container {
  margin: 1rem 0 1.5rem;
  background-color: white;
  border-radius: var(--border-radius-md);
  overflow: hidden;
  box-shadow: 0 1px 5px rgba(0,0,0,0.05);
  border: 1px solid #eee;
  max-width: 95%;
  transition: all 0.3s ease;
}

.sources-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  background-color: #f8f9fa;
}

.sources-header h4 {
  margin: 0;
  font-size: 1rem;
  color: #555;
}

.sources-toggle {
  color: var(--color-primary);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}

.sources-toggle:hover {
  opacity: 0.8;
}

.sources-content {
  padding: 1rem;
  max-height: 500px;
  overflow-y: auto;
}

.source-container {
  margin-bottom: 1.5rem;
  padding: 1.25rem;
  background-color: white;
  border-radius: var(--border-radius-md);
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  border: 1px solid #f0f0f0;
  transition: all 0.2s ease;
}

.source-container:last-child {
  margin-bottom: 0;
}

.source-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}

.source-header {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--color-border);
}

.source-title {
  font-weight: 600;
  font-size: 1rem;
  color: var(--color-heading);
  margin-right: 1rem;
  flex: 1;
}

.source-date {
  font-size: 0.9rem;
  color: #777;
  font-style: italic;
}

.source-text {
  font-size: 0.95rem;
  margin-bottom: 0.75rem;
  line-height: 1.6;
  font-style: italic;
  color: var(--color-text);
  background-color: rgba(0,0,0,0.02);
  padding: 0.75rem;
  border-radius: var(--border-radius-sm);
}

.source-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  font-size: 0.85rem;
  color: #777;
}

.source-time {
  display: flex;
  align-items: center;
}

.source-time::before {
  content: '';
  display: inline-block;
  width: 14px;
  height: 14px;
  margin-right: 0.4rem;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='none' stroke='%23777777' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='12 6 12 12 16 14'%3E%3C/polyline%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
}

.source-match {
  font-weight: 600;
  color: var(--color-primary);
  display: flex;
  align-items: center;
}

.source-match::before {
  content: '';
  display: inline-block;
  width: 14px;
  height: 14px;
  margin-right: 0.4rem;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='none' stroke='%232ea3f2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
}

.source-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin-bottom: 0.75rem;
}

.watch-video-btn, .open-youtube-btn {
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
}

.watch-video-btn {
  background-color: var(--color-primary);
  color: white;
  border: none;
  flex: 1;
}

.watch-video-btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.open-youtube-btn {
  background-color: rgba(46, 163, 242, 0.1);
  color: var(--color-primary);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.open-youtube-btn:hover {
  background-color: rgba(46, 163, 242, 0.2);
  transform: translateY(-2px);
}

.video-embed {
  width: 100%;
  border-radius: var(--border-radius-sm);
  overflow: hidden;
  margin-bottom: 0.75rem;
  transition: all 0.3s ease;
}

.view-all-sources {
  display: block;
  width: 100%;
  padding: 0.75rem;
  margin-top: 1rem;
  background-color: #f8f9fa;
  border: 1px solid #eee;
  border-radius: 6px;
  color: #555;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.view-all-sources:hover {
  background-color: #eef5f9;
  color: var(--color-primary);
}

/* Error states */
.error-container, .connection-error {
  background-color: rgba(231, 76, 60, 0.05);
  padding: 0.75rem;
  border-radius: 8px;
  margin-bottom: 0.5rem;
}

.error-container p, .connection-error p {
  margin-top: 0;
  margin-bottom: 0.75rem;
  color: #c0392b;
}

.retry-button {
  background-color: #f8f9fa;
  border: 1px solid #ddd;
  color: #555;
  padding: 0.5rem 0.75rem;
  border-radius: 4px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.retry-button:hover {
  background-color: #eee;
  transform: translateY(-2px);
}

/* Bible reference highlighting */
.bible-reference {
  color: var(--color-primary);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 0 3px;
  border-radius: 3px;
  text-decoration: none;
  background-color: rgba(46, 163, 242, 0.05);
}

.bible-reference:hover {
  background-color: rgba(46, 163, 242, 0.15);
  text-decoration: underline;
}

/* Make the example questions more interactive */
.example-questions li {
  transition: all 0.2s ease;
  position: relative;
  cursor: pointer;
  padding: 0.75rem 1rem;
  margin-bottom: 0.5rem;
  background-color: #f8f9fa;
  border-radius: 6px;
  border-left: 3px solid var(--color-primary);
}

.example-questions li:hover {
  transform: translateX(5px);
  background-color: rgba(46, 163, 242, 0.1);
}

.example-questions li::after {
  content: '';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='none' stroke='%232ea3f2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='5' y1='12' x2='19' y2='12'%3E%3C/line%3E%3Cpolyline points='12 5 19 12 12 19'%3E%3C/polyline%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.example-questions li:hover::after {
  opacity: 1;
}

/* Responsive styles */
@media (max-width: 768px) {
  .chat-container {
    height: 80vh;
    margin: 1rem auto;
    width: 95%;
  }
  
  .message {
    max-width: 90%;
  }
  
  .source-header {
    flex-direction: column;
  }
  
  .source-date {
    margin-top: 0.5rem;
  }
  
  .source-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .source-actions {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .suggestion-chips {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .suggestion-chip {
    max-width: 100%;
  }
}
</style>

<script>
// Hard-coded API URL as fallback (replace with your actual API URL)
const API_URL = '{{ site.api_url }}' || 'https://sermon-search-api-8fok.onrender.com';

// Add a debug console log to check the API URL
console.log('API URL:', API_URL);

// DOM Elements
const chatForm = document.getElementById('chatForm');
const queryInput = document.getElementById('queryInput');
const messagesContainer = document.getElementById('messages');
const apiStatusBanner = document.getElementById('api-status-banner');
const apiStatusMessage = document.getElementById('api-status-message');
const retryConnectionButton = document.getElementById('retry-connection');

// Bible reference regex for highlighting in responses
const bibleRefRegex = /\b(Genesis|Exodus|Leviticus|Numbers|Deuteronomy|Joshua|Judges|Ruth|1 Samuel|2 Samuel|1 Kings|2 Kings|1 Chronicles|2 Chronicles|Ezra|Nehemiah|Esther|Job|Psalms|Psalm|Proverbs|Ecclesiastes|Song of Solomon|Isaiah|Jeremiah|Lamentations|Ezekiel|Daniel|Hosea|Joel|Amos|Obadiah|Jonah|Micah|Nahum|Habakkuk|Zephaniah|Haggai|Zechariah|Malachi|Matthew|Mark|Luke|John|Acts|Romans|1 Corinthians|2 Corinthians|Galatians|Ephesians|Philippians|Colossians|1 Thessalonians|2 Thessalonians|1 Timothy|2 Timothy|Titus|Philemon|Hebrews|James|1 Peter|2 Peter|1 John|2 John|3 John|Jude|Revelation)\s+\d+(?::\d+(?:-\d+)?)?/gi;

// Add debugging log
console.log('DOM Elements:', {
  chatForm: !!chatForm,
  queryInput: !!queryInput,
  messagesContainer: !!messagesContainer,
  apiStatusBanner: !!apiStatusBanner
});

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing chat...');
  
  // Check if the form exists on this page before attaching events
  if (chatForm) {
    console.log('Chat form found, adding event listeners');
    
    chatForm.addEventListener('submit', handleSubmit);
    
    if (queryInput) {
      queryInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event('submit'));
        }
      });
    }
    
    // Add retry connection button handler
    if (retryConnectionButton) {
      retryConnectionButton.addEventListener('click', verifyApiConnection);
    }
    
    // Make example questions clickable
    setupExampleQuestionClicks();
    
    // Verify API connection on page load
    verifyApiConnection();
  } else {
    console.error('Chat form not found on this page');
  }
});

/**
 * Setup click handlers for example questions in the info section
 */
function setupExampleQuestionClicks() {
  const exampleQuestions = document.querySelectorAll('.example-questions li');
  console.log('Setting up', exampleQuestions.length, 'example questions');
  
  exampleQuestions.forEach(item => {
    item.style.cursor = 'pointer';
    
    item.addEventListener('click', function() {
      const query = this.textContent.trim();
      console.log('Example question clicked:', query);
      
      if (queryInput) {
        queryInput.value = query;
        
        // Smoothly scroll to chat section
        const chatContainer = document.querySelector('.chat-container');
        if (chatContainer) {
          chatContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Short delay before submitting to let scroll complete
        setTimeout(() => {
          chatForm.dispatchEvent(new Event('submit'));
        }, 500);
      }
    });
  });
}

/**
 * Verify API connection
 */
async function verifyApiConnection() {
  console.log('Verifying API connection to:', API_URL);
  
  if (apiStatusBanner) {
    apiStatusBanner.style.display = 'block';
    apiStatusMessage.textContent = 'Checking connection...';
  }
  
  try {
    // Try the root endpoint first
    const rootResponse = await fetch(`${API_URL}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Origin': window.location.origin
      },
      mode: 'cors'
    });
    
    if (!rootResponse.ok) {
      throw new Error(`API connection failed with status: ${rootResponse.status}`);
    }
    
    console.log('API connection successful');
    
    if (apiStatusBanner) {
      apiStatusBanner.style.display = 'none';
    }
    
    return true;
    
  } catch (error) {
    console.error('API connection verification failed:', error);
    
    if (apiStatusBanner && apiStatusMessage) {
      apiStatusBanner.style.display = 'block';
      apiStatusMessage.textContent = `API connection issue: ${error.message}. Check console for details.`;
    }
    
    return false;
  }
}

/**
 * Handle form submission
 */
async function handleSubmit(event) {
  event.preventDefault();
  console.log('Form submitted');
  
  const query = queryInput.value.trim();
  if (!query) {
    console.log('Empty query, ignoring');
    return;
  }
  
  // Add user message to the chat
  addMessage(query, 'user');
  
  // Clear input field
  queryInput.value = '';
  
  // Add loading message
  const loadingMessageId = addLoadingMessage();
  
  try {
    // Send request to API
    const url = `${API_URL}/answer`;
    console.log('Sending request to:', url);
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Origin': window.location.origin
      },
      mode: 'cors',
      body: JSON.stringify({
        query: query,
        top_k: 5,
        include_sources: true
      })
    });
    
    if (!response.ok) {
      console.error('API Error:', response.status, response.statusText);
      throw new Error(`API request failed with status ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Received response:', data);
    
    // Remove loading message
    removeMessage(loadingMessageId);
    
    // Display AI response
    displayAnswer(data);
    
  } catch (error) {
    console.error('Error:', error);
    
    // Remove loading message
    removeMessage(loadingMessageId);
    
    // Show error message with more details
    addMessage(`Sorry, there was an error processing your question (${error.message}). Please try again later or check with your administrator.`, 'bot', true);
  }
}

/**
 * Add a message to the chat
 */
function addMessage(text, sender, isError = false) {
  const messageElement = document.createElement('div');
  messageElement.className = `message ${sender}`;
  
  if (isError) {
    messageElement.classList.add('error');
  }
  
  // For bot messages, process and render HTML properly
  if (sender === 'bot') {
    // First highlight Bible references
    text = highlightBibleReferences(text);
    
    // Set the HTML content directly to properly render HTML tags
    messageElement.innerHTML = text;
    
    // Make all links open in new tab
    const links = messageElement.querySelectorAll('a');
    links.forEach(link => {
      if (!link.hasAttribute('target')) {
        link.setAttribute('target', '_blank');
      }
    });
  } else {
    // For user messages, escape HTML
    messageElement.textContent = text;
  }
  
  messageElement.id = 'msg-' + Date.now();
  messagesContainer.appendChild(messageElement);
  
  // Scroll to the bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  return messageElement.id;
}

/**
 * Add a loading message
 */
function addLoadingMessage() {
  const loadingElement = document.createElement('div');
  loadingElement.className = 'message bot loading';
  loadingElement.innerHTML = '<div class="loading-spinner"></div> Searching sermon content...';
  loadingElement.id = 'loading-' + Date.now();
  messagesContainer.appendChild(loadingElement);
  
  // Scroll to the bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  return loadingElement.id;
}

/**
 * Remove a message by ID
 */
function removeMessage(id) {
  const message = document.getElementById(id);
  if (message) {
    message.remove();
  }
}

/**
 * Format a date string from various possible formats
 */
function formatSermonDate(dateStr) {
  if (!dateStr) return 'Date unknown';
  
  try {
    // Handle YYYYMMDD format (common in the metadata)
    if (typeof dateStr === 'number' || (typeof dateStr === 'string' && /^\d{8}$/.test(dateStr))) {
      const yearStr = String(dateStr).substring(0, 4);
      const monthStr = String(dateStr).substring(4, 6);
      const dayStr = String(dateStr).substring(6, 8);
      
      const year = parseInt(yearStr);
      const month = parseInt(monthStr) - 1; // JavaScript months are 0-indexed
      const day = parseInt(dayStr);
      
      const date = new Date(year, month, day);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      });
    }
    
    // Handle ISO date strings
    if (typeof dateStr === 'string' && dateStr.includes('-')) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      });
    }
    
    // Handle timestamp
    if (typeof dateStr === 'number') {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      });
    }
    
    // Return as is if we can't parse it
    return dateStr;
  } catch (e) {
    console.error(`Error parsing date: ${dateStr}`, e);
    return 'Date unknown';
  }
}

/**
 * Clean and format sermon title
 */
function formatSermonTitle(title) {
  if (!title) return 'Unknown Sermon';
  
  // Remove quotes that might be in the title
  return title.replace(/^["']|["']$/g, '');
}

/**
 * Display the answer and sources from the API
 */
function displayAnswer(data) {
  // Add the answer to the chat - allow HTML rendering
  addMessage(data.answer, 'bot');
  
  // Display sources if available
  if (data.sources && data.sources.length > 0) {
    // Sort sources by similarity score
    const sortedSources = [...data.sources].sort((a, b) => b.similarity - a.similarity);
    
    // Display top sources
    const sourceLimit = 3; // Limit to top 3 sources
    const topSources = sortedSources.slice(0, sourceLimit);
    
    topSources.forEach((source, index) => {
      displaySource(source, index);
    });
  }
}

/**
 * Display a source with video embed and enhanced metadata
 */
function displaySource(source, index) {
  const sourceElement = document.createElement('div');
  sourceElement.className = 'source-container';
  
  const similarity = Math.round(source.similarity * 100);
  const videoUrl = `https://www.youtube.com/embed/${source.video_id}?start=${Math.floor(source.start_time)}`;
  
  // Format title and date for display
  const formattedTitle = formatSermonTitle(source.title);
  const formattedDate = formatSermonDate(source.publish_date);
  
  sourceElement.innerHTML = `
    <div class="source-header">
      <div class="source-title">${escapeHTML(formattedTitle)}</div>
      <div class="source-date">${formattedDate}</div>
    </div>
    <div class="source-text">"${formatText(source.text.substring(0, 150))}${source.text.length > 150 ? '...' : ''}"</div>
    <div class="source-meta">
      <span class="source-time">Timestamp: ${formatTimestamp(source.start_time)}</span>
      <span class="source-match">${similarity}% match</span>
    </div>
    <div class="source-actions">
      <button class="watch-video-btn" onclick="toggleVideo(this)">Watch Video Clip</button>
      <a href="https://www.youtube.com/watch?v=${source.video_id}&t=${Math.floor(source.start_time)}" target="_blank" class="open-youtube-btn">
        Open in YouTube
      </a>
    </div>
    <div class="video-embed" style="display: none;">
      <iframe src="${videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen height="215"></iframe>
    </div>
  `;
  
  messagesContainer.appendChild(sourceElement);
  
  // Scroll to the bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

/**
 * Toggle video display
 */
function toggleVideo(button) {
  const videoEmbed = button.parentElement.nextElementSibling;
  const isHidden = videoEmbed.style.display === 'none';
  
  // Toggle the video display
  videoEmbed.style.display = isHidden ? 'block' : 'none';
  
  // Update the button text
  button.textContent = isHidden ? 'Hide Video' : 'Watch Video Clip';
}

/**
 * Escape HTML for safety
 */
function escapeHTML(str) {
  if (!str) return '';
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

/**
 * Format text (e.g., highlight Bible references)
 */
function formatText(text) {
  if (!text) return '';
  // First escape HTML
  text = escapeHTML(text);
  // Then highlight Bible references
  return highlightBibleReferences(text);
}

/**
 * Highlight Bible references in text
 */
function highlightBibleReferences(text) {
  return text.replace(bibleRefRegex, '<span class="bible-reference">$&</span>');
}

/**
 * Format timestamp to MM:SS
 */
function formatTimestamp(seconds) {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = Math.floor(seconds % 60);
  return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}
</script>