---
layout: default
title: Chat about Sermons
---

<!-- App Container -->
<div class="container">
  <!-- App Header (collapsed on mobile) -->
  <header class="app-header">
    <!-- Language Selector -->
    <div class="language-selector">
      <select id="languageSelect" aria-label="Select language">
        <option value="en" selected>English</option>
        <option value="es">EspaÃ±ol</option>
        <option value="zh">ä¸­æ–‡</option>
      </select>
    </div>
  </header>

  <!-- Chat wrapper - full height -->
  <div class="chat-section-wrapper">
    <!-- Claude-Style Interface -->
    <div class="claude-interface">
      <!-- API Status Banner -->
      <div id="api-status-banner">
        <span id="api-status-message" data-i18n="api-connection-issue">API connection issue detected.</span>
        <button id="retry-connection" class="claude-retry-button" data-i18n="retry">Retry</button>
      </div>
      
      <!-- Chat Panel -->
      <div class="claude-chat-panel">
        <div id="messages" class="claude-messages">
          <!-- Messages will be inserted here by JavaScript -->
        </div>
        
        <div class="claude-input-area">
          <form id="chatForm">
            <div class="claude-input-container">
              <textarea id="queryInput" class="claude-input" placeholder="Ask a question about the sermons..." rows="1"></textarea>
              <button type="submit" class="claude-submit-button">
                <svg class="claude-submit-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                </svg>
              </button>
            </div>
          </form>
          <div class="conversation-controls">
            <button id="clearConversation" class="control-button" data-i18n="clear-conversation">Clear Conversation</button>
          </div>
        </div>
      </div>
      
      <!-- Sources Panel -->
      <div id="sourcesPanel" class="claude-sources-panel">
        <button class="claude-sources-close" id="closeSourcesPanel">Ã—</button>
        <div class="claude-sources-panel-content" id="sourcesPanelContent">
          <!-- Source content will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Info button for mobile (toggles sample questions) -->
  <button class="info-toggle" id="infoToggle">?</button>

  <!-- Help Section (hidden on mobile by default) -->
  <div class="info-section" id="infoSection">
    <h2 class="content-section-header" data-i18n="how-to-use">How to Use This Tool</h2>
    
    <div class="row">
      <div class="col-md-6">
        <div class="content-card">
          <h3 data-i18n="sample-questions">Sample Questions</h3>
          <p data-i18n="examples-intro">Here are some examples of questions you can ask:</p>
          <ul class="example-questions">
            <li data-i18n="example-1">"How does a person get to heaven?"</li>
            <li data-i18n="example-2">"What is the Trinity?"</li>
            <li data-i18n="example-3">"How should Christians live?"</li>
            <li data-i18n="example-4">"Why read the King James Bible?"</li>
            <li data-i18n="example-5">"Who is Melchizedek?"</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
 /**
 * Layered Interface with Full Width Chat
 * - Places sources panel behind content
 * - Preserves full width of chat box
 * - Creates intuitive layering for better UX
 */

(function() {
  // Create and inject necessary styles
  const styleElement = document.createElement('style');
  styleElement.innerHTML = `
    /* Make sure chat box is always full width */
    .chat-section-wrapper,
    .claude-interface,
    .claude-chat-panel,
    .claude-input-area,
    .claude-input-container,
    #messages,
    .claude-messages,
    #chatForm,
    .container {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    /* Input should also take full width */
    #queryInput {
      width: 100% !important;
      flex: 1 !important;
    }
    
    /* Base sources panel styling */
    #sourcesPanel, 
    .claude-sources-panel {
      background-color: rgba(255, 255, 255, 0.98) !important;
      box-shadow: 0 0 20px rgba(0,0,0,0.1) !important;
      z-index: 900 !important; /* Lower z-index to be behind content */
      display: none !important;
      overflow: auto !important;
    }
    
    #sourcesPanel.active, 
    .claude-sources-panel.active {
      display: block !important;
    }
    
    /* Content that should appear above the sources panel */
    .video-embed,
    .transcript-container,
    .iframe-container,
    [id^="transcript-"] {
      position: relative !important;
      z-index: 1000 !important; /* Higher z-index to be above sources panel */
      background-color: white !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
      margin: 1rem auto !important;
      max-width: 95% !important;
      border: 1px solid #eee !important;
      overflow: hidden !important;
    }
    
    /* Mobile sources panel styling */
    @media (max-width: 768px) {
      #sourcesPanel, 
      .claude-sources-panel {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 12px 12px 0 0 !important;
        max-height: 75vh !important;
      }
      
      /* Add scroll indicator handle at top for mobile */
      #sourcesPanel::before,
      .claude-sources-panel::before {
        content: "";
        display: block;
        width: 40px;
        height: 4px;
        background-color: #ddd;
        border-radius: 2px;
        margin: 10px auto;
        position: absolute;
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001 !important;
      }
      
      #sourcesPanelContent, 
      .claude-sources-panel-content {
        max-height: calc(75vh - 40px) !important;
        overflow-y: auto !important;
        padding: 20px !important;
        padding-top: 30px !important;
      }
    }
    
    /* Desktop sources panel styling */
    @media (min-width: 769px) {
      #sourcesPanel, 
      .claude-sources-panel {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 80% !important;
        max-width: 900px !important;
        border-radius: 12px !important;
        max-height: 80vh !important;
      }
      
      #sourcesPanelContent, 
      .claude-sources-panel-content {
        max-height: calc(80vh - 50px) !important;
        overflow-y: auto !important;
        padding: 20px !important;
      }
    }
    
    /* Make the close button float above content */
    #closeSourcesPanel,
    .claude-sources-close {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      background-color: white !important;
      color: #333 !important;
      border-radius: 50% !important;
      width: 36px !important;
      height: 36px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
      cursor: pointer !important;
      font-size: 20px !important;
      z-index: 1001 !important; /* Above everything */
      border: none !important;
      outline: none !important;
    }
    
    /* Style source containers to be more visible against the background */
    .source-container {
      background-color: white !important;
      border-radius: 8px !important;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1) !important;
      padding: 15px !important;
      margin-bottom: 15px !important;
      border: 1px solid #eee !important;
    }
    
    /* Focus effect when interacting with a source */
    .source-container:focus-within {
      box-shadow: 0 1px 8px rgba(46, 163, 242, 0.4) !important;
      border-color: rgba(46, 163, 242, 0.3) !important;
    }
    
    /* Improve button visibility */
    .watch-video-btn,
    .view-transcript-btn,
    .open-youtube-btn {
      z-index: 1001 !important;
      position: relative !important;
      background-color: #f8f9fa !important;
      border: 1px solid #ddd !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
      transition: all 0.2s ease !important;
    }
    
    /* Make sure transcript is properly displayed */
    .transcript-container {
      padding: 20px !important;
      max-height: 60vh !important;
      overflow-y: auto !important;
    }
  `;
  document.head.appendChild(styleElement);
  
  // Function to toggle sources panel
  function toggleSourcesPanel(show) {
    const panel = document.getElementById('sourcesPanel') || 
                  document.querySelector('.claude-sources-panel');
    
    if (!panel) {
      return;
    }
    
    if (show === undefined) {
      // Toggle based on current state
      show = !panel.classList.contains('active');
    }
    
    if (show) {
      // Show panel
      panel.classList.add('active');
    } else {
      // Hide panel
      panel.classList.remove('active');
    }
  }
  
  // Setup close button
  function setupCloseButton() {
    const closeButton = document.getElementById('closeSourcesPanel') ||
                        document.querySelector('.claude-sources-close');
    
    if (closeButton) {
      closeButton.onclick = function() {
        toggleSourcesPanel(false);
      };
    }
  }
  
  // Setup toggle buttons
  function setupToggleButtons() {
    document.addEventListener('click', function(e) {
      const toggleButton = e.target.closest('.claude-sources-toggle') ||
                           e.target.closest('.show-sources');
      
      if (toggleButton) {
        toggleSourcesPanel(true);
      }
    });
  }
  
  // Override the global toggleVideo function to handle layering
  window.toggleVideo = function(button) {
    try {
      if (!button || !button.parentElement) {
        console.error('Invalid button element for toggleVideo');
        return;
      }
      
      const videoEmbed = button.parentElement.nextElementSibling;
      if (!videoEmbed || !videoEmbed.classList.contains('video-embed')) {
        console.error('Could not find video embed element');
        return;
      }
      
      const isHidden = videoEmbed.style.display === 'none';
      
      // Toggle the video display
      videoEmbed.style.display = isHidden ? 'block' : 'none';
      
      // Update the button text safely
      const hideText = typeof translate === 'function' ? translate('hide-video') : 'Hide Video';
      const showText = typeof translate === 'function' ? translate('watch-video') : 'Watch Video';
      button.textContent = isHidden ? hideText : showText;
      
      // Scroll to make video visible if showing
      if (isHidden) {
        setTimeout(() => {
          videoEmbed.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    } catch (error) {
      console.error('Error in toggleVideo:', error);
    }
  };
  
  // Override the global toggleTranscript function to handle layering
  window.toggleTranscript = function(videoId, startTime = 0) {
    try {
      if (!videoId) {
        console.error('Invalid videoId for toggleTranscript');
        return;
      }
      
      const transcriptContainer = document.getElementById(`transcript-${videoId}`);
      const button = document.querySelector(`.view-transcript-btn[onclick*="toggleTranscript('${videoId}')"]`);
      
      if (!transcriptContainer) {
        // Transcript hasn't been loaded yet, fetch it
        fetchTranscript(videoId, startTime);
        
        // Update button text if found
        if (button) {
          button.textContent = typeof translate === 'function' ? 
            translate('hide-transcript') : 'Hide Transcript';
        }
        
        return;
      }
      
      // Toggle visibility
      const isHidden = transcriptContainer.style.display === 'none';
      transcriptContainer.style.display = isHidden ? 'block' : 'none';
      
      // Update button text
      if (button) {
        const hideText = typeof translate === 'function' ? translate('hide-transcript') : 'Hide Transcript';
        const showText = typeof translate === 'function' ? translate('view-transcript') : 'View Transcript';
        button.textContent = isHidden ? hideText : showText;
      }
      
      // Scroll to make transcript visible if showing
      if (isHidden) {
        setTimeout(() => {
          transcriptContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    } catch (error) {
      console.error('Error in toggleTranscript:', error);
    }
  };
  
  // Make sure the global function is available
  window.toggleSourcesPanel = toggleSourcesPanel;
  
  // Initialize
  setupCloseButton();
  setupToggleButtons();
  
  // Watch for DOM changes to find buttons/panel if they're added dynamically
  const observer = new MutationObserver(function() {
    setupCloseButton();
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // Check again after a delay to ensure everything is loaded
  setTimeout(function() {
    setupCloseButton();
  }, 1000);
  
  console.log('Layered interface with full width chat initialized');
})();

</script>
<style>
  /* Focused chat experience with preserved sidebar functionality */
  .chat-section-wrapper {
    position: relative;
    height: 75vh; /* Fixed height using viewport height */
  }

  .claude-interface {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: row;
  }

  .claude-chat-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    min-width: 0; /* Prevent flex items from overflowing */
  }

  .claude-messages {
    flex: 1;
    overflow-y: auto;
  }

  .claude-input-area {
    flex-shrink: 0; /* Prevent input area from shrinking */
  }

  /* Ensure sources panel maintains its sidebar behavior */
  .claude-sources-panel {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 0;
    height: 100% !important; /* Force full height */
    transition: width 0.3s ease;
    overflow: hidden;
  }

  .claude-sources-panel.active {
    width: 40%;
    max-width: 450px;
  }

  /* Hide the info section */
  .info-section {
    display: none;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .chat-section-wrapper {
      height: 80vh; /* Taller on mobile */
    }
    
    /* For mobile, reset sources panel to bottom sheet style */
    .claude-sources-panel {
      position: fixed;
      top: auto;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100% !important;
      height: 0 !important;
      transition: height 0.3s ease;
    }
    
    .claude-sources-panel.active {
      height: 75vh !important;
      width: 100% !important;
      max-width: none;
    }
  }
/* Responsive container improvements */
.container {
  width: 95%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 var(--space-md);
  box-sizing: border-box;
}

/* Larger chat container */
.chat-container {
  max-width: 1000px;
  margin: 2.5rem auto;
  border: 1px solid var(--color-border);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  height: 75vh; /* Increased height */
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background-color: white;
  transition: box-shadow 0.3s ease;
}

.chat-container:focus-within {
  box-shadow: 0 6px 24px rgba(46, 163, 242, 0.15);
}

/* Language selector positioning */
.language-selector {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 1.5rem;
  padding-right: 0.5rem;
}

.language-selector select {
  padding: 0.5rem 1rem;
  border: 1px solid var(--color-border);
  border-radius: var(--border-radius-md);
  background-color: white;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

/* Improved messages container */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  background-color: #f8f9fa;
  scroll-behavior: smooth;
}

/* Better message bubbles */
.message {
  max-width: 85%;
  margin-bottom: 1.25rem;
  padding: 1rem 1.25rem;
  border-radius: 1.2rem;
  position: relative;
  line-height: 1.5;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  word-wrap: break-word;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

.message.user {
  background-color: var(--color-primary);
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 0.3rem;
}

.message.bot {
  background-color: white;
  margin-right: auto;
  border-bottom-left-radius: 0.3rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Better input area */
.chat-controls {
  border-top: 1px solid var(--color-border);
  background-color: white;
  padding: 1rem 1.25rem;
}

.chat-form {
  display: flex;
  align-items: center;
  transition: all 0.3s ease;
}

.chat-input {
  flex: 1;
  padding: 1rem 1.25rem;
  border: 1px solid #e0e5eb;
  border-radius: 10px;
  font: inherit;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05) inset;
  font-size: 1rem;
}

.chat-input:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(46, 163, 242, 0.15);
  outline: none;
}

.chat-button {
  padding: 1rem 1.5rem;
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: 10px;
  margin-left: 0.75rem;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.chat-button:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

/* Conversation controls */
.conversation-controls {
  display: flex;
  justify-content: flex-end;
  margin-top: 0.75rem;
}

.control-button {
  background-color: transparent;
  color: #777;
  border: 1px solid #ddd;
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.control-button:hover {
  background-color: #f5f5f5;
  color: #333;
}

/* Rethought Source Interaction - Tabbed Interface */
.sources-container {
  margin: 1.5rem 0;
  background-color: white;
  border-radius: var(--border-radius-lg);
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  border: 1px solid #eee;
  max-width: 95%;
  transition: all 0.3s ease;
}

/* Source tabs for better organization */
.sources-tabs {
  display: flex;
  background-color: #f8f9fa;
  border-bottom: 1px solid #eee;
}

.source-tab {
  padding: 1rem 1.5rem;
  font-weight: 600;
  color: #777;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  user-select: none;
}

.source-tab.active {
  color: var(--color-primary);
}

.source-tab.active:after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 3px;
  background-color: var(--color-primary);
}

.source-tab:hover {
  background-color: rgba(0,0,0,0.02);
}

.sources-count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(46, 163, 242, 0.1);
  color: var(--color-primary);
  font-size: 0.8rem;
  height: 20px;
  min-width: 20px;
  padding: 0 6px;
  border-radius: 10px;
  margin-left: 8px;
}

/* Content area for each tab */
.tab-content {
  display: none;
  padding: 0;
}

.tab-content.active {
  display: block;
}

/* Sources overview tab */
.sources-overview {
  padding: 1.5rem;
}

.sources-header {
  margin-bottom: 1.5rem;
}

.sources-header h4 {
  margin: 0 0 0.5rem;
  font-size: 1.2rem;
  color: #444;
}

.sources-description {
  color: #666;
  font-size: 0.95rem;
  line-height: 1.5;
}

/* Source cards list */
.source-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
}

.source-card {
  background-color: #f8f9fa;
  border-radius: 10px;
  border: 1px solid #eee;
  padding: 1.25rem;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.source-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  border-color: rgba(46, 163, 242, 0.3);
}

.source-card.active {
  border-color: var(--color-primary);
  background-color: rgba(46, 163, 242, 0.05);
}

.source-card-title {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.75rem;
  color: #333;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;  
  overflow: hidden;
  height: 2.5rem;
}

.source-card-preview {
  font-size: 0.9rem;
  color: #666;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;  
  overflow: hidden;
  margin-bottom: 0.75rem;
  height: 4rem;
}

.source-card-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  color: #777;
}

.source-card-match {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background-color: var(--color-primary);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 20px;
  font-weight: 600;
}

/* Active source detail view */
.source-detail {
  padding: 1.5rem;
}

.source-back-btn {
  display: inline-flex;
  align-items: center;
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 1rem;
  cursor: pointer;
}

.source-back-btn:before {
  content: 'â†';
  margin-right: 0.5rem;
}

.source-back-btn:hover {
  color: var(--color-primary);
}

.source-header {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--color-border);
}

.source-title {
  font-weight: 600;
  font-size: 1.2rem;
  color: var(--color-heading);
  margin-right: 1rem;
  flex: 1;
}

.source-date {
  font-size: 0.95rem;
  color: #777;
  font-style: italic;
}

.source-detail-text {
  font-size: 1rem;
  margin-bottom: 1.25rem;
  line-height: 1.6;
  color: #333;
  background-color: #f8f9fa;
  padding: 1.25rem;
  border-radius: var(--border-radius-md);
  border-left: 3px solid var(--color-primary);
}

.source-meta {
  display: flex;
  align-items: center;
  margin-bottom: 1.25rem;
  font-size: 0.95rem;
}

.source-time {
  display: flex;
  align-items: center;
  margin-right: 1.5rem;
  color: #666;
}

.source-time:before {
  content: 'â±ï¸';
  margin-right: 0.5rem;
}

.source-match {
  display: flex;
  align-items: center;
  font-weight: 600;
  color: var(--color-primary);
}

.source-match:before {
  content: 'ğŸ¯';
  margin-right: 0.5rem;
}

/* Action buttons */
.source-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.watch-video-btn {
  grid-column: span 2;
  background-color: var(--color-primary);
  color: white;
  border: none;
  padding: 1rem;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.watch-video-btn:before {
  content: 'â–¶ï¸';
  margin-right: 0.5rem;
}

.watch-video-btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.open-youtube-btn, 
.view-transcript-btn {
  background-color: #f8f9fa;
  color: #555;
  border: 1px solid #ddd;
  padding: 0.75rem;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.open-youtube-btn:before {
  content: 'ğŸ“º';
  margin-right: 0.5rem;
}

.view-transcript-btn:before {
  content: 'ğŸ“';
  margin-right: 0.5rem;
}

.open-youtube-btn:hover, 
.view-transcript-btn:hover {
  background-color: #eee;
  transform: translateY(-2px);
}

/* Video embed with improved controls */
.video-embed {
  width: 100%;
  border-radius: var(--border-radius-md);
  overflow: hidden;
  margin-bottom: 1.5rem;
  transition: all 0.3s ease;
  background-color: #000;
  position: relative;
  padding-top: 56.25%; /* 16:9 aspect ratio */
  box-shadow: 0 3px 15px rgba(0,0,0,0.1);
}

.video-embed iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.video-embed-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 0.5rem;
}

.video-expand-btn {
  background-color: transparent;
  color: #666;
  border: none;
  padding: 0.5rem;
  font-size: 0.9rem;
  cursor: pointer;
  display: flex;
  align-items: center;
}

.video-expand-btn:before {
  content: 'â¤¢';
  margin-right: 0.5rem;
}

.video-embed.expanded {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90vw;
  height: 90vh;
  padding-top: 0;
  z-index: 1000;
}

.video-embed.expanded iframe {
  width: 100%;
  height: 100%;
}

/* Transcript tab content with better UX */
.transcript-content {
  padding: 1.5rem;
}

.transcript-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.25rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #eee;
}

.transcript-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #444;
  margin: 0;
}

.transcript-search {
  display: flex;
  background-color: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 1.25rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  width: 100%;
}

.transcript-search-input {
  flex: 1;
  padding: 0.75rem 1rem;
  border: none;
  font: inherit;
  outline: none;
}

.transcript-search-button {
  padding: 0.75rem 1.25rem;
  background-color: white;
  color: #555;
  border: none;
  border-left: 1px solid #eee;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
}

.transcript-search-button:before {
  content: 'ğŸ”';
  margin-right: 0.5rem;
}

.transcript-search-button:hover {
  background-color: #f5f5f5;
}

.transcript-player {
  display: flex;
  margin-bottom: 1.25rem;
  background-color: #f8f9fa;
  border-radius: 10px;
  padding: 1rem;
  align-items: center;
}

.transcript-current-time {
  font-size: 1.1rem;
  font-weight: 600;
  color: #444;
  margin-right: 1rem;
  font-family: monospace;
}

.transcript-controls {
  display: flex;
  gap: 0.75rem;
}

.transcript-control-btn {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 20px;
  background-color: white;
  color: #555;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.transcript-control-btn:hover {
  background-color: var(--color-primary);
  color: white;
}

.transcript-segments {
  height: 400px;
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 8px;
  background-color: white;
}

.transcript-segment {
  display: flex;
  padding: 0.75rem;
  border-bottom: 1px solid #f5f5f5;
  transition: all 0.2s ease;
  cursor: pointer;
}

.transcript-segment:hover {
  background-color: #f8f9fa;
}

.transcript-segment.active {
  background-color: rgba(46, 163, 242, 0.05);
  border-left: 3px solid var(--color-primary);
}

.transcript-timestamp {
  flex: 0 0 70px;
  color: #777;
  font-size: 0.9rem;
  font-family: monospace;
  font-weight: 600;
  display: flex;
  align-items: center;
}

.transcript-text {
  flex: 1;
  line-height: 1.6;
}

.transcript-highlight {
  background-color: rgba(255, 230, 0, 0.4);
  padding: 2px 4px;
  border-radius: 2px;
}

/* Custom scrollbar just for transcript */
.transcript-segments::-webkit-scrollbar {
  width: 6px;
}

.transcript-segments::-webkit-scrollbar-track {
  background: #f5f5f5;
}

.transcript-segments::-webkit-scrollbar-thumb {
  background: #ddd;
  border-radius: 3px;
}

.transcript-segments::-webkit-scrollbar-thumb:hover {
  background: #ccc;
}

.transcript-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 1rem;
}

.transcript-download-btn {
  display: flex;
  align-items: center;
  padding: 0.6rem 1rem;
  background-color: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 6px;
  color: #555;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.transcript-download-btn:before {
  content: 'ğŸ“¥';
  margin-right: 0.5rem;
}

.transcript-download-btn:hover {
  background-color: #eee;
}

.transcript-view-options {
  display: flex;
  gap: 0.5rem;
}

.transcript-view-btn {
  padding: 0.6rem 1rem;
  background-color: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 6px;
  color: #555;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.transcript-view-btn.active {
  background-color: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
}

.transcript-view-btn:hover:not(.active) {
  background-color: #eee;
}

.transcript-highlight {
  background-color: rgba(255, 230, 0, 0.4);
  padding: 2px 0;
  border-radius: 2px;
}

/* Welcome message styling */
.welcome-message {
  width: 100%;
  max-width: 90%;
  background-color: rgba(46, 163, 242, 0.05);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  border-left: 4px solid var(--color-primary);
}

.welcome-message h4 {
  margin-top: 0;
  color: var(--color-primary);
  margin-bottom: 0.75rem;
  font-size: 1.3rem;
}

.welcome-message p {
  line-height: 1.6;
  margin-bottom: 1rem;
}

/* Enhanced suggestion chips */
.suggestion-heading {
  margin: 1.25rem 0 0.75rem;
  font-weight: 600;
  color: #555;
}

.suggestion-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.suggestion-chip {
  background-color: rgba(46, 163, 242, 0.1);
  color: var(--color-primary);
  border: 1px solid rgba(46, 163, 242, 0.2);
  padding: 0.75rem 1.25rem;
  border-radius: 100px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 250px;
}

.suggestion-chip:hover {
  background-color: rgba(46, 163, 242, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Better bot message formatting */
.message.bot p {
  margin-bottom: 1rem;
  line-height: 1.6;
}

.message.bot p:last-child {
  margin-bottom: 0;
}

.message.bot strong {
  display: block;
  font-size: 1.1em;
  color: #333;
  margin: 1rem 0 0.75rem;
}

.message.bot ul, 
.message.bot ol {
  padding-left: 1.5rem;
  margin: 0.75rem 0;
}

.message.bot li {
  margin-bottom: 0.5rem;
}

.message.bot .bible-reference {
  color: var(--color-primary);
  font-weight: 600;
  cursor: pointer;
  padding: 0 3px;
  border-radius: 3px;
  background-color: rgba(46, 163, 242, 0.05);
  display: inline-block;
}

.message.bot .bible-reference:hover {
  background-color: rgba(46, 163, 242, 0.15);
  text-decoration: underline;
}

/* Fix scrollbars for smoother appearance */
.messages::-webkit-scrollbar,
.sources-content::-webkit-scrollbar,
.transcript-container::-webkit-scrollbar {
  width: 8px;
}

.messages::-webkit-scrollbar-track,
.sources-content::-webkit-scrollbar-track,
.transcript-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.messages::-webkit-scrollbar-thumb,
.sources-content::-webkit-scrollbar-thumb,
.transcript-container::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 10px;
}

.messages::-webkit-scrollbar-thumb:hover,
.sources-content::-webkit-scrollbar-thumb:hover,
.transcript-container::-webkit-scrollbar-thumb:hover {
  background: #aaa;
}

/* Improved example questions */
.example-questions li {
  transition: all 0.2s ease;
  position: relative;
  cursor: pointer;
  padding: 0.9rem 1.25rem;
  margin-bottom: 0.75rem;
  background-color: #f8f9fa;
  border-radius: 8px;
  border-left: 3px solid var(--color-primary);
}

.example-questions li:hover {
  transform: translateX(5px);
  background-color: rgba(46, 163, 242, 0.1);
}

.example-questions li::after {
  content: '';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' fill='none' stroke='%232ea3f2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='5' y1='12' x2='19' y2='12'%3E%3C/line%3E%3Cpolyline points='12 5 19 12 12 19'%3E%3C/polyline%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.example-questions li:hover::after {
  opacity: 1;
}

/* Bible reference tables */
.message.bot table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
  font-size: 0.95rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  border-radius: 6px;
  overflow: hidden;
}

.message.bot th,
.message.bot td {
  border: 1px solid #e2e8f0;
  padding: 0.75rem 1rem;
  text-align: left;
  vertical-align: top;
}

.message.bot th {
  background-color: #f8f9fa;
  font-weight: 600;
  color: #333;
}

.message.bot tr:nth-child(even) {
  background-color: #f8f9fa;
}

/* Responsive styles */
@media (max-width: 768px) {
  /* Mobile container */
  .container {
    width: 100%;
    padding: 0 1rem;
  }
  
  /* Fullscreen chat on mobile */
  .chat-container {
    width: 100%;
    margin: 1rem 0;
    height: 80vh;
    border-radius: 0;
    box-shadow: none;
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
    border-left: none;
    border-right: none;
  }
  
  /* Larger messages on mobile */
  .message {
    max-width: 90%;
    padding: 1rem;
  }
  
  /* Optimize language selector */
  .language-selector {
    justify-content: center;
    margin-bottom: 1rem;
  }
  
  /* Optimize input area */
  .chat-controls {
    padding: 0.75rem;
  }
  
  .chat-form {
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .chat-input {
    width: 100%;
    padding: 0.9rem;
  }
  
  .chat-button {
    width: 100%;
    margin-left: 0;
    padding: 0.9rem;
  }
  
  /* Source improvements for mobile */
  .sources-container {
    width: 100%;
    max-width: 100%;
    margin: 1rem 0;
    border-radius: 8px;
  }
  
  /* Make tab interface more mobile-friendly */
  .sources-tabs {
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 5px; /* Prevent scrollbar from cutting off content */
  }
  
  .source-tab {
    padding: 0.8rem 1rem;
    font-size: 0.9rem;
  }
  
  /* Source card grid for mobile */
  .source-cards {
    grid-template-columns: 1fr;
  }
  
  .source-card {
    padding: 1rem;
  }
  
  /* Optimize source detail view */
  .source-detail {
    padding: 1rem;
  }
  
  .source-header {
    flex-direction: column;
  }
  
  .source-title {
    margin-right: 0;
    margin-bottom: 0.5rem;
  }
  
  .source-date {
    margin-bottom: 0.5rem;
  }
  
  .source-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  /* Simplify action buttons on mobile */
  .source-actions {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }
  
  .watch-video-btn {
    grid-column: span 1;
  }
  
  /* Transcript optimizations for mobile */
  .transcript-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .transcript-search {
    flex-direction: column;
  }
  
  .transcript-search-input {
    width: 100%;
    border-bottom: 1px solid #eee;
  }
  
  .transcript-search-button {
    width: 100%;
    justify-content: center;
    border-left: none;
  }
  
  .transcript-player {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .transcript-segments {
    height: 300px; /* Smaller height on mobile */
  }
  
  .transcript-segment {
    flex-direction: column;
  }
  
  .transcript-timestamp {
    margin-bottom: 0.25rem;
  }
  
  .transcript-actions {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .transcript-download-btn,
  .transcript-view-options {
    width: 100%;
  }
  
  .transcript-view-btn {
    flex: 1;
    text-align: center;
    padding: 0.6rem 0.5rem;
  }
  
  /* Improved welcome message on mobile */
  .welcome-message {
    max-width: 100%;
    padding: 1rem;
  }
  
  /* Better suggestion chips layout */
  .suggestion-chips {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .suggestion-chip {
    max-width: 100%;
    text-align: center;
  }
  
  /* Ensure tables are scrollable on mobile */
  .message.bot table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
  
  /* Optimize info section for mobile */
  .info-section {
    padding: 1rem;
  }
  
  .content-card {
    padding: 1rem;
  }
  
  .example-questions li {
    padding: 0.75rem 1rem;
  }
  
  /* Fix expanded video on mobile */
  .video-embed.expanded {
    width: 100vw;
    height: 60vh; /* Smaller height on mobile */
  }
}

/* Dark mode support (optional) */
@media (prefers-color-scheme: dark) {
  .chat-container {
    background-color: #1f2937;
    border-color: #374151;
  }
  
  .messages {
    background-color: #111827;
  }
  
  .message.bot {
    background-color: #2d3748;
    color: #e2e8f0;
  }
  
  .chat-controls {
    background-color: #1f2937;
    border-color: #374151;
  }
  
  .chat-input {
    background-color: #374151;
    border-color: #4b5563;
    color: #e2e8f0;
  }
  
  .sources-container {
    background-color: #1f2937;
    border-color: #374151;
  }
  
  .sources-header {
    background-color: #111827;
    border-color: #374151;
  }
  
  .sources-header h4 {
    color: #e2e8f0;
  }
  
  .source-container {
    background-color: #2d3748;
    border-color: #4b5563;
  }
  
  .source-title {
    color: #e2e8f0;
  }
  
  .source-text {
    background-color: rgba(255,255,255,0.05);
    color: #d1d5db;
  }
  
  .welcome-message {
    background-color: rgba(46, 163, 242, 0.1);
  }
  
  .example-questions li {
    background-color: #2d3748;
  }
  
  .message.bot .bible-reference {
    background-color: rgba(46, 163, 242, 0.15);
  }
}
</style>
<script>
/**
 * Enhanced Multilingual Sermon Search with Conversation Memory
 * Supports English, Spanish, and Chinese
 */

// API Configuration
const API_URL = '{{ site.api_url }}' || 'https://sermon-search-api-8fok.onrender.com';

// Safely get DOM elements with error handling
function safeGetElement(id) {
  const element = document.getElementById(id);
  if (!element) {
    console.warn(`Element with ID '${id}' not found`);
  }
  return element;
}

// DOM Elements - Using safe getter
const chatForm = safeGetElement('chatForm');
const queryInput = safeGetElement('queryInput');
const messagesContainer = safeGetElement('messages');
const apiStatusBanner = safeGetElement('api-status-banner');
const apiStatusMessage = safeGetElement('api-status-message');
const retryConnectionButton = safeGetElement('retry-connection');
const languageSelect = safeGetElement('languageSelect');
const clearConversationBtn = safeGetElement('clearConversation');

// Bible reference regex for different languages
const bibleRefRegexByLanguage = {
  en: /\b(Genesis|Exodus|Leviticus|Numbers|Deuteronomy|Joshua|Judges|Ruth|1 Samuel|2 Samuel|1 Kings|2 Kings|1 Chronicles|2 Chronicles|Ezra|Nehemiah|Esther|Job|Psalms|Psalm|Proverbs|Ecclesiastes|Song of Solomon|Isaiah|Jeremiah|Lamentations|Ezekiel|Daniel|Hosea|Joel|Amos|Obadiah|Jonah|Micah|Nahum|Habakkuk|Zephaniah|Haggai|Zechariah|Malachi|Matthew|Mark|Luke|John|Acts|Romans|1 Corinthians|2 Corinthians|Galatians|Ephesians|Philippians|Colossians|1 Thessalonians|2 Thessalonians|1 Timothy|2 Timothy|Titus|Philemon|Hebrews|James|1 Peter|2 Peter|1 John|2 John|3 John|Jude|Revelation)\s+\d+(?::\d+(?:-\d+)?)?/gi,
  
  es: /\b(GÃ©nesis|Ã‰xodo|LevÃ­tico|NÃºmeros|Deuteronomio|JosuÃ©|Jueces|Rut|1 Samuel|2 Samuel|1 Reyes|2 Reyes|1 CrÃ³nicas|2 CrÃ³nicas|Esdras|NehemÃ­as|Ester|Job|Salmos|Salmo|Proverbios|EclesiastÃ©s|Cantares|Cantar de los Cantares|IsaÃ­as|JeremÃ­as|Lamentaciones|Ezequiel|Daniel|Oseas|Joel|AmÃ³s|AbdÃ­as|JonÃ¡s|Miqueas|NahÃºm|Habacuc|SofonÃ­as|Hageo|ZacarÃ­as|MalaquÃ­as|Mateo|Marcos|Lucas|Juan|Hechos|Romanos|1 Corintios|2 Corintios|GÃ¡latas|Efesios|Filipenses|Colosenses|1 Tesalonicenses|2 Tesalonicenses|1 Timoteo|2 Timoteo|Tito|FilemÃ³n|Hebreos|Santiago|1 Pedro|2 Pedro|1 Juan|2 Juan|3 Juan|Judas|Apocalipsis)\s+\d+(?::\d+(?:-\d+)?)?/gi,
  
  zh: /\b(åˆ›ä¸–è®°|å‡ºåŸƒåŠè®°|åˆ©æœªè®°|æ°‘æ•°è®°|ç”³å‘½è®°|çº¦ä¹¦äºšè®°|å£«å¸ˆè®°|è·¯å¾—è®°|æ’’æ¯è€³è®°ä¸Š|æ’’æ¯è€³è®°ä¸‹|åˆ—ç‹çºªä¸Š|åˆ—ç‹çºªä¸‹|å†ä»£å¿—ä¸Š|å†ä»£å¿—ä¸‹|ä»¥æ–¯æ‹‰è®°|å°¼å¸Œç±³è®°|ä»¥æ–¯å¸–è®°|çº¦ä¼¯è®°|è¯—ç¯‡|ç®´è¨€|ä¼ é“ä¹¦|é›…æ­Œ|ä»¥èµ›äºšä¹¦|è€¶åˆ©ç±³ä¹¦|è€¶åˆ©ç±³å“€æ­Œ|ä»¥è¥¿ç»“ä¹¦|ä½†ä»¥ç†ä¹¦|ä½•è¥¿é˜¿ä¹¦|çº¦ç¥ä¹¦|é˜¿æ‘©å¸ä¹¦|ä¿„å·´åº•äºšä¹¦|çº¦æ‹¿ä¹¦|å¼¥è¿¦ä¹¦|é‚£é¸¿ä¹¦|å“ˆå·´è°·ä¹¦|è¥¿ç•ªé›…ä¹¦|å“ˆè¯¥ä¹¦|æ’’è¿¦åˆ©äºšä¹¦|ç›æ‹‰åŸºä¹¦|é©¬å¤ªç¦éŸ³|é©¬å¯ç¦éŸ³|è·¯åŠ ç¦éŸ³|çº¦ç¿°ç¦éŸ³|ä½¿å¾’è¡Œä¼ |ç½—é©¬ä¹¦|å“¥æ—å¤šå‰ä¹¦|å“¥æ—å¤šåä¹¦|åŠ æ‹‰å¤ªä¹¦|ä»¥å¼—æ‰€ä¹¦|è…“ç«‹æ¯”ä¹¦|æ­Œç½—è¥¿ä¹¦|å¸–æ’’ç½—å°¼è¿¦å‰ä¹¦|å¸–æ’’ç½—å°¼è¿¦åä¹¦|ææ‘©å¤ªå‰ä¹¦|ææ‘©å¤ªåä¹¦|æå¤šä¹¦|è…“åˆ©é—¨ä¹¦|å¸Œä¼¯æ¥ä¹¦|é›…å„ä¹¦|å½¼å¾—å‰ä¹¦|å½¼å¾—åä¹¦|çº¦ç¿°ä¸€ä¹¦|çº¦ç¿°äºŒä¹¦|çº¦ç¿°ä¸‰ä¹¦|çŠ¹å¤§ä¹¦|å¯ç¤ºå½•)\s*\d+(?::\d+(?:-\d+)?)?/gi
};

// Get appropriate Bible reference regex for current language
function getBibleReferenceRegexForLanguage() {
  return bibleRefRegexByLanguage[currentLanguage] || bibleRefRegexByLanguage.en;
}

// Translations
const translations = {
  en: {
    "sermon-search-tool": "Sermon Search Tool",
    "tool-description": "This interactive tool uses AI to search through sermon transcripts and provide relevant answers to your questions about the pastor's teachings.",
    "api-connection-issue": "API connection issue detected. Check your internet connection or try again later.",
    "retry": "Retry",
    "send": "Send",
    "clear-conversation": "Clear Conversation",
    "how-to-use": "How to Use This Tool",
    "sample-questions": "Sample Questions",
    "examples-intro": "Here are some examples of questions you can ask:",
    "example-1": "How does a person get to heaven?",
    "example-2": "What is the Trinity?",
    "example-3": "How should Christians live?",
    "example-4": "Why read the King James Bible?",
    "example-5": "Who is Melchizedek?",
    "about-tool": "About This Tool",
    "search-explanation": "This search tool uses artificial intelligence to analyze sermon transcripts and provide relevant information.",
    "ai-features": "When you ask a question, the AI will:",
    "feature-1": "Search through the entire sermon library",
    "feature-2": "Find the most relevant content to your question",
    "feature-3": "Provide direct links to video timestamps",
    "feature-4": "Show you the exact context where information was found",
    "answers-source": "All answers are based solely on the pastor's actual sermon content.",
    "tips": "Tips for Better Results",
    "tip-1": "Be specific in your questions",
    "tip-2": "Include Bible references if relevant",
    "tip-3": "Ask about specific topics or passages",
    "tip-4": "Try reformulating if you don't get a helpful answer",
    "tip-5": "You can ask follow-up questions for clarification",
    "tip-6": "Check the video links to hear the full context",
    "what-does-pastor-teach": "What does the pastor teach about faith?",
    "welcome-title": "Welcome to the Sermon Search Tool! ğŸ‘‹",
    "welcome-intro": "Ask any question about the pastor's sermons, and I'll provide answers based on the sermon content with timestamped video links.",
    "suggestion-heading": "Try asking about:",
    "watch-video": "Watch Video Clip",
    "hide-video": "Hide Video",
    "view-transcript": "View Transcript",
    "hide-transcript": "Hide Transcript",
    "open-youtube": "Open in YouTube",
    "loading-transcript": "Loading transcript...",
    "show-sources": "Show Sources",
    "hide-sources": "Hide Sources",
    "sources-found": "Sources Found",
    "view-all-sources": "View All Sources",
    "searching": "Searching sermon content...",
    "no-results": "No relevant sermon content found to answer this question.",
    "connection-error": "Sorry, I can't reach the sermon database right now. Please check your internet connection.",
    "try-again": "Try Again",
    "continue-conversation": "You can continue the conversation by asking follow-up questions."
  },
  es: {
    "sermon-search-tool": "Herramienta de BÃºsqueda de Sermones",
    "tool-description": "Esta herramienta interactiva utiliza IA para buscar en las transcripciones de sermones y proporcionar respuestas relevantes a sus preguntas sobre las enseÃ±anzas del pastor.",
    "api-connection-issue": "Se detectÃ³ un problema de conexiÃ³n con la API. Compruebe su conexiÃ³n a Internet o intÃ©ntelo de nuevo mÃ¡s tarde.",
    "retry": "Reintentar",
    "send": "Enviar",
    "clear-conversation": "Borrar ConversaciÃ³n",
    "how-to-use": "CÃ³mo Usar Esta Herramienta",
    "sample-questions": "Preguntas de Ejemplo",
    "examples-intro": "AquÃ­ hay algunos ejemplos de preguntas que puede hacer:",
    "example-1": "Â¿CÃ³mo puede una persona ir al cielo?",
    "example-2": "Â¿QuÃ© es la Trinidad?",
    "example-3": "Â¿CÃ³mo deben vivir los cristianos?",
    "example-4": "Â¿Por quÃ© leer la Biblia Reina Valera?",
    "example-5": "Â¿QuiÃ©n es Melquisedec?",
    "about-tool": "Acerca de Esta Herramienta",
    "search-explanation": "Esta herramienta de bÃºsqueda utiliza inteligencia artificial para analizar transcripciones de sermones y proporcionar informaciÃ³n relevante.",
    "ai-features": "Cuando hace una pregunta, la IA:",
    "feature-1": "Busca en toda la biblioteca de sermones",
    "feature-2": "Encuentra el contenido mÃ¡s relevante para su pregunta",
    "feature-3": "Proporciona enlaces directos a marcas de tiempo de video",
    "feature-4": "Le muestra el contexto exacto donde se encontrÃ³ la informaciÃ³n",
    "answers-source": "Todas las respuestas se basan Ãºnicamente en el contenido real de los sermones del pastor.",
    "tips": "Consejos para Mejores Resultados",
    "tip-1": "Sea especÃ­fico en sus preguntas",
    "tip-2": "Incluya referencias bÃ­blicas si es relevante",
    "tip-3": "Pregunte sobre temas o pasajes especÃ­ficos",
    "tip-4": "Intente reformular si no obtiene una respuesta Ãºtil",
    "tip-5": "Puede hacer preguntas de seguimiento para aclaraciÃ³n",
    "tip-6": "Consulte los enlaces de video para escuchar el contexto completo",
    "what-does-pastor-teach": "Â¿QuÃ© enseÃ±a el pastor sobre la fe?",
    "welcome-title": "Â¡Bienvenido a la Herramienta de BÃºsqueda de Sermones! ğŸ‘‹",
    "welcome-intro": "Haga cualquier pregunta sobre los sermones del pastor, y le proporcionarÃ© respuestas basadas en el contenido del sermÃ³n con enlaces de video con marca de tiempo.",
    "suggestion-heading": "Intente preguntar sobre:",
    "watch-video": "Ver Clip de Video",
    "hide-video": "Ocultar Video",
    "view-transcript": "Ver TranscripciÃ³n",
    "hide-transcript": "Ocultar TranscripciÃ³n",
    "open-youtube": "Abrir en YouTube",
    "loading-transcript": "Cargando transcripciÃ³n...",
    "show-sources": "Mostrar Fuentes",
    "hide-sources": "Ocultar Fuentes",
    "sources-found": "Fuentes Encontradas",
    "view-all-sources": "Ver Todas las Fuentes",
    "searching": "Buscando contenido de sermones...",
    "no-results": "No se encontrÃ³ contenido de sermÃ³n relevante para responder a esta pregunta.",
    "connection-error": "Lo siento, no puedo acceder a la base de datos de sermones en este momento. Por favor, compruebe su conexiÃ³n a Internet.",
    "try-again": "Intentar de Nuevo",
    "continue-conversation": "Puede continuar la conversaciÃ³n haciendo preguntas de seguimiento."
  },
  zh: {
    "sermon-search-tool": "è®²é“æœç´¢å·¥å…·",
    "tool-description": "è¿™ä¸ªäº¤äº’å¼å·¥å…·ä½¿ç”¨äººå·¥æ™ºèƒ½æœç´¢è®²é“æ–‡ç¨¿ï¼Œå¹¶æ ¹æ®ç‰§å¸ˆçš„æ•™å¯¼ä¸ºæ‚¨çš„é—®é¢˜æä¾›ç›¸å…³ç­”æ¡ˆã€‚",
    "api-connection-issue": "æ£€æµ‹åˆ°APIè¿æ¥é—®é¢˜ã€‚è¯·æ£€æŸ¥æ‚¨çš„äº’è”ç½‘è¿æ¥æˆ–ç¨åå†è¯•ã€‚",
    "retry": "é‡è¯•",
    "send": "å‘é€",
    "clear-conversation": "æ¸…é™¤å¯¹è¯",
    "how-to-use": "å¦‚ä½•ä½¿ç”¨æ­¤å·¥å…·",
    "sample-questions": "ç¤ºä¾‹é—®é¢˜",
    "examples-intro": "ä»¥ä¸‹æ˜¯ä¸€äº›æ‚¨å¯ä»¥æé—®çš„ç¤ºä¾‹é—®é¢˜ï¼š",
    "example-1": "ä¸€ä¸ªäººå¦‚ä½•æ‰èƒ½ä¸Šå¤©å ‚ï¼Ÿ",
    "example-2": "ä¸‰ä½ä¸€ä½“æ˜¯ä»€ä¹ˆï¼Ÿ",
    "example-3": "åŸºç£å¾’åº”è¯¥å¦‚ä½•ç”Ÿæ´»ï¼Ÿ",
    "example-4": "ä¸ºä»€ä¹ˆè¦è¯»é’¦å®šç‰ˆåœ£ç»ï¼Ÿ",
    "example-5": "éº¦åŸºæ´—å¾·æ˜¯è°ï¼Ÿ",
    "about-tool": "å…³äºæ­¤å·¥å…·",
    "search-explanation": "è¿™ä¸ªæœç´¢å·¥å…·ä½¿ç”¨äººå·¥æ™ºèƒ½åˆ†æè®²é“æ–‡ç¨¿å¹¶æä¾›ç›¸å…³ä¿¡æ¯ã€‚",
    "ai-features": "å½“æ‚¨æå‡ºé—®é¢˜æ—¶ï¼Œäººå·¥æ™ºèƒ½å°†ï¼š",
    "feature-1": "æœç´¢æ•´ä¸ªè®²é“åº“",
    "feature-2": "æ‰¾åˆ°ä¸æ‚¨é—®é¢˜æœ€ç›¸å…³çš„å†…å®¹",
    "feature-3": "æä¾›ç›´æ¥é“¾æ¥åˆ°è§†é¢‘æ—¶é—´æˆ³",
    "feature-4": "å‘æ‚¨å±•ç¤ºæ‰¾åˆ°ä¿¡æ¯çš„ç¡®åˆ‡ä¸Šä¸‹æ–‡",
    "answers-source": "æ‰€æœ‰ç­”æ¡ˆå®Œå…¨åŸºäºç‰§å¸ˆçš„å®é™…è®²é“å†…å®¹ã€‚",
    "tips": "è·å¾—æ›´å¥½ç»“æœçš„æç¤º",
    "tip-1": "åœ¨é—®é¢˜ä¸­å…·ä½“æ˜ç¡®",
    "tip-2": "å¦‚æœç›¸å…³ï¼Œè¯·åŒ…å«åœ£ç»å¼•ç”¨",
    "tip-3": "è¯¢é—®ç‰¹å®šä¸»é¢˜æˆ–æ®µè½",
    "tip-4": "å¦‚æœæ²¡æœ‰å¾—åˆ°æœ‰ç”¨çš„ç­”æ¡ˆï¼Œè¯·å°è¯•é‡æ–°è¡¨è¿°",
    "tip-5": "æ‚¨å¯ä»¥æå‡ºåç»­é—®é¢˜ä»¥è·å–æ¾„æ¸…",
    "tip-6": "æŸ¥çœ‹è§†é¢‘é“¾æ¥ä»¥å¬å–å®Œæ•´ä¸Šä¸‹æ–‡",
    "what-does-pastor-teach": "ç‰§å¸ˆå…³äºä¿¡å¿ƒæœ‰ä»€ä¹ˆæ•™å¯¼ï¼Ÿ",
    "welcome-title": "æ¬¢è¿ä½¿ç”¨è®²é“æœç´¢å·¥å…·ï¼ğŸ‘‹",
    "welcome-intro": "è¯¢é—®ä»»ä½•å…³äºç‰§å¸ˆè®²é“çš„é—®é¢˜ï¼Œæˆ‘å°†æ ¹æ®è®²é“å†…å®¹æä¾›å¸¦æœ‰æ—¶é—´æˆ³è§†é¢‘é“¾æ¥çš„ç­”æ¡ˆã€‚",
    "suggestion-heading": "å°è¯•è¯¢é—®å…³äºï¼š",
    "watch-video": "è§‚çœ‹è§†é¢‘ç‰‡æ®µ",
    "hide-video": "éšè—è§†é¢‘",
    "view-transcript": "æŸ¥çœ‹æ–‡ç¨¿",
    "hide-transcript": "éšè—æ–‡ç¨¿",
    "open-youtube": "åœ¨YouTubeä¸Šæ‰“å¼€",
    "loading-transcript": "æ­£åœ¨åŠ è½½æ–‡ç¨¿...",
    "show-sources": "æ˜¾ç¤ºæ¥æº",
    "hide-sources": "éšè—æ¥æº",
    "sources-found": "æ‰¾åˆ°çš„æ¥æº",
    "view-all-sources": "æŸ¥çœ‹æ‰€æœ‰æ¥æº",
    "searching": "æ­£åœ¨æœç´¢è®²é“å†…å®¹...",
    "no-results": "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®²é“å†…å®¹æ¥å›ç­”è¿™ä¸ªé—®é¢˜ã€‚",
    "connection-error": "æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•è®¿é—®è®²é“æ•°æ®åº“ã€‚è¯·æ£€æŸ¥æ‚¨çš„äº’è”ç½‘è¿æ¥ã€‚",
    "try-again": "é‡è¯•",
    "continue-conversation": "æ‚¨å¯ä»¥é€šè¿‡æå‡ºåç»­é—®é¢˜ç»§ç»­å¯¹è¯ã€‚"
  }
};

// Bible website configurations for different languages
const bibleWebsites = {
  en: {
    site: "https://www.biblegateway.com/passage/",
    version: "KJV"
  },
  es: {
    site: "https://www.biblegateway.com/passage/",
    version: "RVR1960"
  },
  zh: {
    site: "https://www.biblegateway.com/passage/",
    version: "CUVS"
  }
};

// Spanish conversational fallbacks
const spanishFallbacks = {
  clarify_previous: `No tengo contenido especÃ­fico de sermones que responda a tu pregunta sobre ese tema. 

A partir del contenido del sermÃ³n que discutimos anteriormente, el pastor se centrÃ³ mÃ¡s en la aplicaciÃ³n prÃ¡ctica que en explicaciones detalladas. Â¿Te gustarÃ­a que sugiriera un aspecto diferente de este tema que podrÃ­a estar cubierto en los sermones? Â¿O quizÃ¡s podrÃ­as reformular tu pregunta para centrarte en un pasaje bÃ­blico especÃ­fico o una aplicaciÃ³n prÃ¡ctica?`,

  follow_up: `No pude encontrar contenido de sermones que aborde especÃ­ficamente ese aspecto en relaciÃ³n con tu pregunta de seguimiento. 

El pastor puede haber cubierto esto en otros sermones que no estÃ¡n en nuestra base de datos actual. Â¿Te gustarÃ­a que te ayudara a explorar un tema relacionado que sÃ­ estÃ¡ cubierto en los sermones? Por ejemplo, podrÃ­a buscar contenido de sermones sobre los fundamentos bÃ­blicos o aplicaciones prÃ¡cticas relacionadas con este tema.`,

  suggest_related: `No pude encontrar contenido de sermones que responda directamente a tu pregunta. 

Es posible que el pastor haya discutido esto en otros sermones o desde una perspectiva diferente a como formulaste tu pregunta. PodrÃ­as intentar buscar:
- TÃ©rminos bÃ­blicos mÃ¡s especÃ­ficos
- Mencionar un pasaje de la Biblia que te interese
- Preguntar sobre la aplicaciÃ³n prÃ¡ctica de un principio espiritual

Â¿Te gustarÃ­a que te ayudara a reformular tu pregunta?`,

  refine_search: `No pude encontrar contenido de sermones que responda directamente a tu pregunta. El pastor puede haber abordado este tema usando una terminologÃ­a diferente o desde un Ã¡ngulo distinto.

Para ayudarme a encontrar contenido de sermones relevante, podrÃ­as:
- Intentar usar tÃ©rminos bÃ­blicos mÃ¡s especÃ­ficos
- Mencionar un pasaje de la Biblia que te interese
- Preguntar sobre la aplicaciÃ³n prÃ¡ctica de un principio espiritual
- Enfocarte en un aspecto especÃ­fico de la vida cristiana

Â¿Te gustarÃ­a que te ayudara a reformular tu pregunta?`,

  generic: `No tengo contenido de sermones que responda directamente a tu pregunta. Sin embargo, estarÃ­a encantado de ayudarte a explorar otros temas de las enseÃ±anzas del pastor.

AquÃ­ hay algunos temas que estÃ¡n bien cubiertos en la base de datos de sermones:
- OraciÃ³n y comunicaciÃ³n con Dios
- Fe y confianza en tiempos difÃ­ciles
- InterpretaciÃ³n bÃ­blica y comprensiÃ³n
- Vida cristiana prÃ¡ctica

Â¿Te gustarÃ­a que buscara contenido de sermones sobre alguno de estos temas en su lugar?`
};

// Chinese conversational fallbacks
const chineseFallbacks = {
  clarify_previous: `æˆ‘æ²¡æœ‰æ‰¾åˆ°ç‰¹å®šçš„è®²é“å†…å®¹æ¥å›ç­”ä½ å…³äºè¿™ä¸ªä¸»é¢˜çš„é—®é¢˜ã€‚

ä»æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„è®²é“å†…å®¹æ¥çœ‹ï¼Œç‰§å¸ˆæ›´å¤šåœ°å…³æ³¨å®é™…åº”ç”¨è€Œä¸æ˜¯è¯¦ç»†è§£é‡Šã€‚ä½ æƒ³è®©æˆ‘å»ºè®®è¿™ä¸ªä¸»é¢˜çš„å…¶ä»–æ–¹é¢ï¼Œè¿™äº›æ–¹é¢å¯èƒ½åœ¨è®²é“ä¸­æœ‰æ‰€æ¶‰åŠå—ï¼Ÿæˆ–è€…ï¼Œä½ å¯ä»¥é‡æ–°è¡¨è¿°ä½ çš„é—®é¢˜ï¼Œä¸“æ³¨äºç‰¹å®šçš„åœ£ç»æ®µè½æˆ–å®é™…åº”ç”¨ã€‚`,

  follow_up: `æˆ‘æ‰¾ä¸åˆ°ç‰¹åˆ«é’ˆå¯¹ä½ çš„åç»­é—®é¢˜çš„è®²é“å†…å®¹ã€‚

ç‰§å¸ˆå¯èƒ½åœ¨æˆ‘ä»¬å½“å‰æ•°æ®åº“ä¸­æ²¡æœ‰çš„å…¶ä»–è®²é“ä¸­è®²è¿‡è¿™ä¸ªå†…å®¹ã€‚ä½ æƒ³è®©æˆ‘å¸®ä½ æ¢ç´¢è®²é“ä¸­æ¶µç›–çš„ç›¸å…³ä¸»é¢˜å—ï¼Ÿä¾‹å¦‚ï¼Œæˆ‘å¯ä»¥æœç´¢ä¸æ­¤ä¸»é¢˜ç›¸å…³çš„åœ£ç»åŸºç¡€æˆ–å®é™…åº”ç”¨çš„è®²é“å†…å®¹ã€‚`,

  suggest_related: `æˆ‘æ‰¾ä¸åˆ°ç›´æ¥å›ç­”ä½ é—®é¢˜çš„è®²é“å†…å®¹ã€‚

ç‰§å¸ˆå¯èƒ½åœ¨å…¶ä»–è®²é“ä¸­è®¨è®ºè¿‡è¿™ä¸ªé—®é¢˜ï¼Œæˆ–è€…ä»ä¸ä½ æé—®æ–¹å¼ä¸åŒçš„è§’åº¦è®¨è®ºè¿‡ã€‚ä½ å¯ä»¥å°è¯•æœç´¢ï¼š
- æ›´å…·ä½“çš„åœ£ç»æœ¯è¯­
- æåŠä½ æ„Ÿå…´è¶£çš„åœ£ç»æ®µè½
- è¯¢é—®å±çµåŸåˆ™çš„å®é™…åº”ç”¨

ä½ æƒ³è®©æˆ‘å¸®ä½ é‡æ–°è¡¨è¿°ä½ çš„é—®é¢˜å—ï¼Ÿ`,

  refine_search: `æˆ‘æ‰¾ä¸åˆ°ç›´æ¥å›ç­”ä½ é—®é¢˜çš„è®²é“å†…å®¹ã€‚ç‰§å¸ˆå¯èƒ½ä½¿ç”¨ä¸åŒçš„æœ¯è¯­æˆ–ä»ä¸åŒçš„è§’åº¦è®¨è®ºè¿‡è¿™ä¸ªä¸»é¢˜ã€‚

ä¸ºäº†å¸®æˆ‘æ‰¾åˆ°ç›¸å…³çš„è®²é“å†…å®¹ï¼Œä½ å¯ä»¥ï¼š
- å°è¯•ä½¿ç”¨æ›´å…·ä½“çš„åœ£ç»æœ¯è¯­
- æåŠä½ æ„Ÿå…´è¶£çš„åœ£ç»æ®µè½
- è¯¢é—®å±çµåŸåˆ™çš„å®é™…åº”ç”¨
- ä¸“æ³¨äºåŸºç£å¾’ç”Ÿæ´»çš„ç‰¹å®šæ–¹é¢

ä½ æƒ³è®©æˆ‘å¸®ä½ é‡æ–°è¡¨è¿°ä½ çš„é—®é¢˜å—ï¼Ÿ`,

  generic: `æˆ‘æ²¡æœ‰ç›´æ¥å›ç­”ä½ é—®é¢˜çš„è®²é“å†…å®¹ã€‚ä½†æ˜¯ï¼Œæˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ æ¢ç´¢ç‰§å¸ˆæ•™å¯¼ä¸­çš„å…¶ä»–ä¸»é¢˜ã€‚

ä»¥ä¸‹æ˜¯åœ¨è®²é“æ•°æ®åº“ä¸­æœ‰è¯¦ç»†ä»‹ç»çš„ä¸€äº›ä¸»é¢˜ï¼š
- ç¥·å‘Šå’Œä¸ä¸Šå¸æ²Ÿé€š
- åœ¨å›°éš¾æ—¶æœŸçš„ä¿¡å¿ƒå’Œä¿¡ä»»
- åœ£ç»è§£é‡Šå’Œç†è§£
- å®é™…çš„åŸºç£å¾’ç”Ÿæ´»

ä½ æƒ³è®©æˆ‘æœç´¢å…³äºè¿™äº›ä¸»é¢˜çš„è®²é“å†…å®¹å—ï¼Ÿ`
};

// Conversation memory
let conversationHistory = [];
const MAX_MEMORY_LENGTH = 10; // Maximum number of exchanges to remember

// Example queries for the user (will be translated)
const sampleQueries = [
  "example-1",
  "example-2", 
  "example-3",
  "example-4", 
  "example-5"
];

// Keep track of whether this is first load
let isFirstLoad = true;

// Current language
let currentLanguage = 'en';

// Add global error handler
window.addEventListener('error', function(event) {
  console.error('Global error caught:', event.error);
  
  // Try to show error in the UI if possible
  if (messagesContainer) {
    const errorMsg = `
      <div class="error-container">
        <p>A script error occurred: ${event.error.message}. Try refreshing the page.</p>
      </div>
    `;
    
    try {
      addMessage(errorMsg, 'bot', true);
    } catch (e) {
      console.error('Could not display error message:', e);
    }
  }
  
  // Prevent the error from causing more issues
  event.preventDefault();
});

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing sermon search...');
  
  // Check if the form exists on this page before attaching events
  if (chatForm) {
    console.log('Chat form found, adding event listeners');
    
    chatForm.addEventListener('submit', function(event) {
      try {
        handleSubmit(event);
      } catch (error) {
        console.error('Error in form submission handler:', error);
        if (messagesContainer) {
          // Show error to user
          const errorMsg = `
            <div class="error-container">
              <p>Sorry, an error occurred: ${error.message}</p>
            </div>
          `;
          addMessage(errorMsg, 'bot', true);
        }
      }
    });
    
    if (queryInput) {
      // Set a static placeholder instead of cycling
      queryInput.placeholder = "Ask a question about the sermons...";
      
      queryInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event('submit'));
        }
      });
      
      // Focus the input field on page load
      setTimeout(() => queryInput.focus(), 500);
    }
    
    // Add language change handler
    if (languageSelect) {
      languageSelect.addEventListener('change', function() {
        changeLanguage(this.value);
      });
    }
    
    // Add clear conversation handler
    if (clearConversationBtn) {
      clearConversationBtn.addEventListener('click', clearConversation);
    }
    
    // Add retry connection button handler
    if (retryConnectionButton) {
      retryConnectionButton.addEventListener('click', function() {
        verifyApiConnection(true);
      });
    }
    
    // Verify API connection on page load
    verifyApiConnection(false);
    
    // Add suggested queries for first-time users
    if (isFirstLoad) {
      displayWelcomeMessage();
    }
    
    // Make example questions clickable
    setupExampleQuestionClicks();
    
    // Set initial language
    changeLanguage(languageSelect.value);
    
    // Add transcript styles
    addTranscriptStyles();
  } else {
    console.error('Chat form not found on this page');
  }
});

/**
 * Add custom styles for transcript feature
 */
function addTranscriptStyles() {
  const styleElement = document.createElement('style');
  styleElement.textContent = `
    /* Enhanced transcript styles */
    .transcript-container {
      margin-top: 1rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #eee;
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .transcript-note {
      padding: 8px 12px;
      background-color: rgba(255, 243, 205, 0.5);
      border-left: 3px solid #ffc107;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    
    .transcript-info {
      margin-bottom: 12px;
      color: #666;
      font-size: 0.9rem;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .transcript-segment {
      margin-bottom: 10px;
      display: flex;
      transition: background-color 0.2s ease;
      padding: 4px;
      border-radius: 4px;
    }
    
    .transcript-segment:hover {
      background-color: rgba(46, 163, 242, 0.05);
    }
    
    .transcript-highlight-segment {
      background-color: rgba(46, 163, 242, 0.1);
      border-left: 3px solid var(--color-primary);
      padding-left: 8px;
    }
    
    .transcript-timestamp {
      flex: 0 0 60px;
      color: #777;
      font-size: 0.85rem;
      padding-top: 0.25rem;
      font-family: monospace;
      font-weight: bold;
    }
    
    .transcript-text {
      flex: 1;
      line-height: 1.5;
    }
    
    .transcript-search {
      display: flex;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }
    
    .transcript-search-input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font: inherit;
    }
    
    .transcript-search-button {
      padding: 0.5rem 0.75rem;
      background-color: var(--color-primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .transcript-search-button:hover {
      opacity: 0.9;
    }
    
    .transcript-match-count {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
    
    .transcript-highlight {
      background-color: rgba(255, 230, 0, 0.4);
      padding: 2px 0;
      border-radius: 2px;
    }
    
    .transcript-loading {
      text-align: center;
      padding: 1rem;
      color: #777;
      font-style: italic;
    }
    
    .transcript-error {
      padding: 0.75rem;
      background-color: rgba(231, 76, 60, 0.1);
      color: #c0392b;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    
    .transcript-timestamp-helper {
      margin-bottom: 10px;
      color: #666;
      font-size: 0.8rem;
      font-style: italic;
      text-align: center;
    }
    
    .retry-button {
      display: block;
      margin: 10px auto;
      padding: 6px 12px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .retry-button:hover {
      background-color: #e5e5e5;
    }
    
    /* Conversational suggestion styles */
    .suggestion-list {
      margin-top: 10px;
    }
    
    .suggestion-list li {
      margin-bottom: 5px;
      cursor: pointer;
      color: var(--color-primary);
      text-decoration: underline;
    }
    
    .suggestion-list li:hover {
      opacity: 0.8;
    }
    
    /* Enhanced continue-hint styling */
    .continue-hint {
      text-align: center;
      margin: 10px 0;
      font-style: italic;
      color: #666;
    }
    
    /* Highlight for conversation mode responses */
    .message.bot.conversation-mode {
      border-left: 3px solid var(--color-primary);
    }
  `;
  
  document.head.appendChild(styleElement);
}

/**
 * Display welcome message with instructions
 */
function displayWelcomeMessage() {
  // Add welcome message with instructions
  const welcomeMsg = `
    <div class="welcome-message">
      <h4>${translate('welcome-title')}</h4>
      <p>${translate('welcome-intro')}</p>
      <p class="suggestion-heading">${translate('suggestion-heading')}</p>
      <div class="suggestion-chips">
        ${getTranslatedQueries().map(query => 
          `<button class="suggestion-chip" data-query="${query}">${query}</button>`
        ).join('')}
      </div>
    </div>
  `;
  
  addMessage(welcomeMsg, 'bot');
  
  // Add click handlers for suggestion chips
  document.querySelectorAll('.suggestion-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      const query = this.getAttribute('data-query');
      queryInput.value = query;
      chatForm.dispatchEvent(new Event('submit'));
    });
  });
  
  isFirstLoad = false;
}

/**
 * Get translated sample queries
 */
function getTranslatedQueries() {
  return sampleQueries.map(key => translate(key));
}

/**
 * Setup click handlers for example questions in the info section
 */
function setupExampleQuestionClicks() {
  const exampleQuestions = document.querySelectorAll('.example-questions li');
  console.log('Setting up', exampleQuestions.length, 'example questions');
  
  exampleQuestions.forEach(item => {
    item.style.cursor = 'pointer';
    
    item.addEventListener('click', function() {
      const query = this.textContent.trim();
      console.log('Example question clicked:', query);
      
      if (queryInput) {
        queryInput.value = query;
        
        // Smoothly scroll to chat section
        const chatContainer = document.querySelector('.chat-container');
        if (chatContainer) {
          chatContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Short delay before submitting to let scroll complete
        setTimeout(() => {
          chatForm.dispatchEvent(new Event('submit'));
        }, 500);
      }
    });
  });
}

/**
 * Change the interface language
 */
function changeLanguage(language) {
  if (!translations[language]) {
    console.error(`Translations for language "${language}" not found`);
    return;
  }
  
  currentLanguage = language;
  console.log(`Language changed to ${language}`);
  
  // Update direction for RTL languages (if needed in the future)
  document.documentElement.classList.remove('rtl');
  if (language === 'ar' || language === 'he') {
    document.documentElement.classList.add('rtl');
  }
  
  // Update all translatable elements
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (translations[language][key]) {
      element.textContent = translations[language][key];
    }
  });
  
  // Update placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    if (translations[language][key]) {
      element.placeholder = translations[language][key];
    }
  });
  
  // Set static placeholder for query input
  if (queryInput) {
    // Clear existing interval if any
    if (queryInput.dataset.cycleInterval && queryInput.dataset.cycleInterval !== 'null') {
      clearInterval(parseInt(queryInput.dataset.cycleInterval));
    }
    // Set static placeholder with translated text
    queryInput.placeholder = translate('what-does-pastor-teach');
  }
  
  // Update welcome message if it exists - Try to update existing welcome message
  if (isFirstLoad) {
    displayWelcomeMessage();
  } else {
    // Try to update existing welcome content without clearing conversation
    const welcomeTitle = document.querySelector('.welcome-message h4');
    const welcomeIntro = document.querySelector('.welcome-message p:first-of-type');
    const suggestionHeading = document.querySelector('.suggestion-heading');
    
    if (welcomeTitle) welcomeTitle.textContent = translate('welcome-title');
    if (welcomeIntro) welcomeIntro.textContent = translate('welcome-intro');
    if (suggestionHeading) suggestionHeading.textContent = translate('suggestion-heading');
    
    // Update suggestion chips text
    document.querySelectorAll('.suggestion-chip').forEach((chip, index) => {
      if (index < sampleQueries.length) {
        const translatedQuery = translate(sampleQueries[index]);
        chip.textContent = translatedQuery;
        chip.setAttribute('data-query', translatedQuery);
      }
    });
  }
  
  // Update any Bible references in existing messages
  updateBibleReferencesForLanguage();
}

/**
 * Update Bible references when language changes
 */
function updateBibleReferencesForLanguage() {
  // Get all bot messages
  const botMessages = document.querySelectorAll('.message.bot:not(.typing-indicator)');
  
  botMessages.forEach(message => {
    // Find all Bible references in this message
    const bibleRefs = message.querySelectorAll('.bible-reference');
    
    bibleRefs.forEach(ref => {
      // Get current text
      const currentReference = ref.textContent.trim();
      
      // Update the click handler to use the current language
      ref.addEventListener('click', function() {
        // Open Bible reference in a Bible website with current language
        const bibleConfig = bibleWebsites[currentLanguage] || bibleWebsites.en;
        window.open(`${bibleConfig.site}?search=${encodeURIComponent(currentReference)}&version=${bibleConfig.version}`, '_blank');
      });
    });
  });
}

/**
 * Translate a key to the current language
 */
function translate(key) {
  if (!translations[currentLanguage]) {
    return key;
  }
  
  return translations[currentLanguage][key] || key;
}

/**
 * Verify API connection
 */
async function verifyApiConnection(showFeedback = false) {
  console.log('Verifying API connection to:', API_URL);
  
  if (showFeedback) {
    // Show checking message
    if (apiStatusBanner) {
      apiStatusBanner.style.display = 'block';
      apiStatusBanner.style.backgroundColor = '#f0f9ff';
      apiStatusBanner.style.color = '#2ea3f2';
      apiStatusMessage.textContent = 'Checking connection...';
    }
  } else {
    // Hide banner initially
    if (apiStatusBanner) {
      apiStatusBanner.style.display = 'none';
    }
  }
  
  try {
    // Try the root endpoint first
    const rootResponse = await fetch(`${API_URL}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Origin': window.location.origin
      },
      mode: 'cors'
    });
    
    if (!rootResponse.ok) {
      throw new Error(`API connection failed with status: ${rootResponse.status}`);
    }
    
    console.log('API connection successful');
    
    // Show success message if feedback was requested
    if (showFeedback) {
      if (apiStatusBanner) {
        apiStatusBanner.style.backgroundColor = '#f0fff4';
        apiStatusBanner.style.color = '#2ecc71';
        apiStatusMessage.textContent = 'Connected successfully!';
        
        // Hide after 3 seconds
        setTimeout(() => {
          apiStatusBanner.style.display = 'none';
        }, 3000);
      }
    }
    
    return true;
    
  } catch (error) {
    console.error('API connection verification failed:', error);
    
    if (apiStatusBanner && apiStatusMessage) {
      apiStatusBanner.style.display = 'block';
      apiStatusBanner.style.backgroundColor = '#fef2f2';
      apiStatusBanner.style.color = '#b91c1c';
      apiStatusMessage.textContent = translate('api-connection-issue');
    }
    
    return false;
  }
}

/**
 * Clear the conversation history
 */
function clearConversation() {
  // Clear the conversation history array
  conversationHistory = [];
  
  // Clear the messages container
  messagesContainer.innerHTML = '';
  
  // Display welcome message again
  displayWelcomeMessage();
  
  // Focus the input field
  if (queryInput) {
    queryInput.focus();
  }
}

/**
 * Format the text with markdown-like syntax - IMPROVED VERSION for multilingual
 */
function formatResponse(text) {
  if (!text) return '';
  
  // Convert line breaks to HTML breaks for proper rendering
  text = text.replace(/\n/g, '<br>');
  
  // Replace section headers (text between ** **)
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  // Format numbered lists (more robust pattern)
  text = text.replace(/(\d+\.\s+)([^\n<]+)(<br>|$)/g, '<div class="list-item"><span class="list-number">$1</span>$2</div>$3');
  
  // Highlight Bible references with the appropriate language regex
  text = text.replace(getBibleReferenceRegexForLanguage(), '<span class="bible-reference">$&</span>');
  
  // Wrap paragraphs in <p> tags, but not if they're already in a div or other block element
  text = text.replace(/(^|<\/div>)([^<]+)(<br>|$)/g, '$1<p>$2</p>$3');
  
  // Clean up any extra <br> tags after </p> tags
  text = text.replace(/<\/p><br>/g, '</p>');
  
  return text;
}

/**
 * Add a message to the chat - IMPROVED VERSION with Bible reference handling
 */
function addMessage(text, sender, isError = false) {
  const messageElement = document.createElement('div');
  messageElement.className = `message ${sender}`;
  messageElement.id = 'msg-' + Date.now(); // Add an ID to each message for reference
  
  if (isError) {
    messageElement.classList.add('error');
  }
  
  // For bot messages, apply formatting
  if (sender === 'bot') {
    if (text.startsWith('<div class="welcome-message">') || 
        text.startsWith('<div class="error-container">') ||
        text.startsWith('<div class="connection-error">')) {
      // For pre-formatted HTML content, use it directly
      messageElement.innerHTML = text;
    } else {
      // For regular text responses, apply the formatting
      const formattedText = formatResponse(text);
      messageElement.innerHTML = formattedText;
    }
    
    // Make all links open in new tab
    const links = messageElement.querySelectorAll('a');
    links.forEach(link => {
      if (!link.hasAttribute('target')) {
        link.setAttribute('target', '_blank');
      }
    });
    
    // Make Bible references clickable
    setupBibleReferenceClicks(messageElement);
    
  } else {
    // For user messages, use text content for safety
    messageElement.textContent = text;
  }
  
  messagesContainer.appendChild(messageElement);
  
  // Scroll to the bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  return messageElement;
}

/**
 * Setup Bible reference clicks for a DOM element
 */
function setupBibleReferenceClicks(element) {
  if (!element) return;
  
  const bibleRefs = element.querySelectorAll('.bible-reference');
  
  bibleRefs.forEach(ref => {
    ref.addEventListener('click', function() {
      const reference = this.textContent.trim();
      const bibleConfig = bibleWebsites[currentLanguage] || bibleWebsites.en;
      
      window.open(`${bibleConfig.site}?search=${encodeURIComponent(reference)}&version=${bibleConfig.version}`, '_blank');
    });
  });
}

/**
 * Add a typing indicator
 */
function addTypingIndicator() {
  const typingElement = document.createElement('div');
  typingElement.className = 'message bot typing-indicator message-appear';
  typingElement.id = 'typing-' + Date.now();
  
  typingElement.innerHTML = `
    <div class="typing-dots">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
  `;
  
  messagesContainer.appendChild(typingElement);
  
  // Scroll to the bottom
  smoothScrollToBottom(messagesContainer);
  
  return typingElement.id;
}

/**
 * Smooth scroll to the bottom of a container
 */
function smoothScrollToBottom(container) {
  const scrollHeight = container.scrollHeight;
  const currentScroll = container.scrollTop + container.clientHeight;
  const targetScroll = scrollHeight;
  
  // Only smooth scroll if we're reasonably close to the bottom already
  // This avoids jarring scrolling when lots of content is added
  if (targetScroll - currentScroll < 500) {
    container.scrollTo({
      top: targetScroll,
      behavior: 'smooth'
    });
  } else {
    container.scrollTop = targetScroll;
  }
}

/**
 * Remove a message by ID
 */
function removeMessage(id) {
  const message = document.getElementById(id);
  if (message) {
    // Add fade-out animation
    message.classList.add('message-disappear');
    
    // Remove after animation completes
    setTimeout(() => {
      message.remove();
    }, 300);
  }
}

/**
 * Format a date string from various possible formats
 */
function formatSermonDate(dateStr) {
  if (!dateStr) return 'Date unknown';
  
  try {
    // Handle YYYYMMDD format (common in the metadata)
    if (typeof dateStr === 'number' || (typeof dateStr === 'string' && /^\d{8}$/.test(dateStr))) {
      const yearStr = String(dateStr).substring(0, 4);
      const monthStr = String(dateStr).substring(4, 6);
      const dayStr = String(dateStr).substring(6, 8);
      
      const year = parseInt(yearStr);
      const month = parseInt(monthStr) - 1; // JavaScript months are 0-indexed
      const day = parseInt(dayStr);
      
      const date = new Date(year, month, day);
      return new Intl.DateTimeFormat(currentLanguage, {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      }).format(date);
    }
    
    // Handle ISO date strings
    if (typeof dateStr === 'string' && dateStr.includes('-')) {
      const date = new Date(dateStr);
      return new Intl.DateTimeFormat(currentLanguage, {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      }).format(date);
    }
    
    // Handle timestamp
    if (typeof dateStr === 'number') {
      const date = new Date(dateStr);
      return new Intl.DateTimeFormat(currentLanguage, {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
      }).format(date);
    }
    
    // Return as is if we can't parse it
    return dateStr;
  } catch (e) {
    console.error(`Error parsing date: ${dateStr}`, e);
    return 'Date unknown';
  }
}

/**
 * Clean and format sermon title
 */
function formatSermonTitle(title) {
  if (!title) return 'Unknown Sermon';
  
  // Remove quotes that might be in the title
  return title.replace(/^["']|["']$/g, '');
}

/**
 * Format timestamp to MM:SS
 */
function formatTimestamp(seconds) {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = Math.floor(seconds % 60);
  return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

/**
 * Topic categories to help classify questions
 */
const SERMON_TOPICS = [
  "prayer", "faith", "forgiveness", "salvation", "holy spirit",
  "discipleship", "worship", "evangelism", "relationships", "suffering",
  "biblical interpretation", "theology", "christian living", "spiritual growth"
];

/**
 * Extract topics from the query text
 */
function extractTopics(text, topicList) {
  const foundTopics = [];
  const lowerText = text.toLowerCase();
  
  // Check for explicit topic mentions
  topicList.forEach(topic => {
    if (lowerText.includes(topic.toLowerCase())) {
      foundTopics.push(topic);
    }
  });
  
  // Check for related words/synonyms
  const topicSynonyms = {
    "prayer": ["praying", "pray", "intercession", "supplication"],
    "faith": ["belief", "trust", "believing", "faithful"],
    "forgiveness": ["forgiving", "forgive", "pardon", "mercy"],
    "relationships": ["marriage", "family", "parenting", "friendship"]
    // Add more synonyms as needed
  };
  
  // Check for synonyms
  Object.entries(topicSynonyms).forEach(([topic, synonyms]) => {
    if (!foundTopics.includes(topic)) {
      for (const synonym of synonyms) {
        if (lowerText.includes(synonym.toLowerCase())) {
          foundTopics.push(topic);
          break;
        }
      }
    }
  });
  
  return foundTopics;
}

/**
 * Extract topics from previous sermon content
 */
function extractPreviousSermonTopics(conversationHistory) {
  const topics = [];
  
  // Look through past assistant responses for sermon content
  for (let i = conversationHistory.length - 1; i >= 0; i--) {
    const message = conversationHistory[i];
    
    // Only process assistant messages
    if (message.role === 'assistant') {
      // Skip messages that indicate no sermon content was found
      if (message.content.includes("No relevant sermon content found")) {
        continue;
      }
      
      // Extract topics from the message content
      SERMON_TOPICS.forEach(topic => {
        if (message.content.toLowerCase().includes(topic.toLowerCase()) && !topics.includes(topic)) {
          topics.push(topic);
        }
      });
    }
  }
  
  return topics;
}

/**
 * Main handler for conversation mode
 * Call this when the API returns no sermon content
 */
function handleConversationFallback(query, conversationHistory) {
  // Extract topics from the current query
  const queryTopics = extractTopics(query, SERMON_TOPICS);
  
  // Extract topics from previous responses that had sermon content
  const previousSermonTopics = extractPreviousSermonTopics(conversationHistory);
  
  // Analyze conversation to determine the best fallback strategy
  const fallbackStrategy = determineFallbackStrategy(query, conversationHistory, queryTopics, previousSermonTopics);
  
  // Generate the appropriate fallback response
  return generateFallbackResponse(query, conversationHistory, fallbackStrategy, queryTopics, previousSermonTopics);
}

/**
 * Determine the appropriate fallback strategy
 */
function determineFallbackStrategy(query, conversationHistory, queryTopics, previousSermonTopics) {
  // Default strategy
  let strategy = "suggest_related";
  
  // Check if this is a clarification question about previous content
  if (isClarificationQuestion(query, conversationHistory)) {
    strategy = "clarify_previous";
  }
  // Check if this is a follow-up question to previous content
  else if (isFollowUpQuestion(query, conversationHistory)) {
    strategy = "follow_up";
  }
  // Check if we should suggest related topics
  else if (queryTopics.length > 0) {
    strategy = "suggest_related";
  }
  // If completely new topic with no relation to previous, suggest search refinement
  else {
    strategy = "refine_search";
  }
  
  return strategy;
}

/**
 * Check if the query is asking for clarification about previous content
 */
function isClarificationQuestion(query, conversationHistory) {
  const clarificationPatterns = {
    en: [
      "what do you mean", "can you explain", "what does that mean",
      "could you clarify", "i don't understand", "please explain"
    ],
    es: [
      "quÃ© quieres decir", "puedes explicar", "quÃ© significa eso",
      "podrÃ­as aclarar", "no entiendo", "por favor explica"
    ],
    zh: [
      "ä½ æ˜¯ä»€ä¹ˆæ„æ€", "ä½ èƒ½è§£é‡Š", "è¿™æ˜¯ä»€ä¹ˆæ„æ€",
      "èƒ½å¦æ¾„æ¸…", "æˆ‘ä¸æ˜ç™½", "è¯·è§£é‡Š"
    ]
  };
  
  const referencePatterns = {
    en: ["you said", "you mentioned", "that sermon", "the pastor said"],
    es: ["dijiste", "mencionaste", "ese sermÃ³n", "el pastor dijo"],
    zh: ["ä½ è¯´", "ä½ æåˆ°", "é‚£ä¸ªè®²é“", "ç‰§å¸ˆè¯´"]
  };
  
  const patterns = clarificationPatterns[currentLanguage] || clarificationPatterns.en;
  const refPatterns = referencePatterns[currentLanguage] || referencePatterns.en;
  
  const lowerQuery = query.toLowerCase();
  
  // Check for clarification phrases
  for (const pattern of patterns) {
    if (lowerQuery.includes(pattern)) {
      return true;
    }
  }
  
  // Check if question refers to previous content
  for (const pattern of refPatterns) {
    if (lowerQuery.includes(pattern)) {
      return true;
    }
  }
  
  return false;
}

/**
 * Check if the query is a follow-up to previous content
 */
function isFollowUpQuestion(query, conversationHistory) {
  if (conversationHistory.length < 2) return false;
  
  const followUpPatterns = {
    en: [
      "more about", "tell me more", "elaborate", "and what about",
      "what else", "in addition", "furthermore", "also"
    ],
    es: [
      "mÃ¡s sobre", "dime mÃ¡s", "elabora", "y quÃ© hay de",
      "quÃ© mÃ¡s", "ademÃ¡s", "tambiÃ©n", "asimismo"
    ],
    zh: [
      "æ›´å¤šå…³äº", "å‘Šè¯‰æˆ‘æ›´å¤š", "è¯¦ç»†è¯´æ˜", "é‚£ä¹ˆå…³äº",
      "è¿˜æœ‰ä»€ä¹ˆ", "æ­¤å¤–", "è€Œä¸”", "ä¹Ÿ"
    ]
  };
  
  const patterns = followUpPatterns[currentLanguage] || followUpPatterns.en;
  const lowerQuery = query.toLowerCase();
  
  // Check for follow-up indicators
  for (const pattern of patterns) {
    if (lowerQuery.includes(pattern)) {
      return true;
    }
  }
  
  // Check if it's related to the last topic discussed
  const lastResponse = findLastSermonResponse(conversationHistory);
  if (lastResponse) {
    const lastResponseTopics = extractTopics(lastResponse, SERMON_TOPICS);
    const queryTopics = extractTopics(query, SERMON_TOPICS);
    
    // If there's topic overlap, it's likely a follow-up
    for (const topic of queryTopics) {
      if (lastResponseTopics.includes(topic)) {
        return true;
      }
    }
  }
  
  return false;
}

/**
 * Find the last response that contained sermon content
 */
function findLastSermonResponse(conversationHistory) {
  for (let i = conversationHistory.length - 1; i >= 0; i--) {
    const message = conversationHistory[i];
    if (message.role === 'assistant' && !message.content.includes("No relevant sermon content found")) {
      return message.content;
    }
  }
  return null;
}

/**
 * Generate a conversational fallback response based on the determined strategy
 */
function generateFallbackResponse(query, conversationHistory, fallbackStrategy, queryTopics, previousSermonTopics) {
  // First check if we have a language-specific message
  // For Spanish
  if (currentLanguage === 'es') {
    switch (fallbackStrategy) {
      case "clarify_previous":
        return spanishFallbacks.clarify_previous;
      case "follow_up":
        return spanishFallbacks.follow_up;
      case "suggest_related":
        return spanishFallbacks.suggest_related;
      case "refine_search":
        return spanishFallbacks.refine_search;
      default:
        return spanishFallbacks.generic;
    }
  }
  
  // For Chinese
  if (currentLanguage === 'zh') {
    switch (fallbackStrategy) {
      case "clarify_previous":
        return chineseFallbacks.clarify_previous;
      case "follow_up":
        return chineseFallbacks.follow_up;
      case "suggest_related":
        return chineseFallbacks.suggest_related;
      case "refine_search":
        return chineseFallbacks.refine_search;
      default:
        return chineseFallbacks.generic;
    }
  }
  
  // For English, we use the original implementation
  let response = "";
  
  switch (fallbackStrategy) {
    case "clarify_previous":
      response = generateClarificationResponse(query, conversationHistory);
      break;
    case "follow_up":
      response = generateFollowUpResponse(query, conversationHistory, queryTopics);
      break;
    case "suggest_related":
      response = generateRelatedTopicsResponse(query, queryTopics, previousSermonTopics);
      break;
    case "refine_search":
      response = generateSearchRefinementResponse(query);
      break;
    default:
      response = generateGenericFallbackResponse(query);
  }
  
  return response;
}

/**
 * Generate a response to clarify previous content
 */
function generateClarificationResponse(query, conversationHistory) {
  const lastResponse = findLastSermonResponse(conversationHistory);
  if (!lastResponse) {
    return generateGenericFallbackResponse(query);
  }
  
  // Extract topic of the clarification
  const topics = extractTopics(query, SERMON_TOPICS);
  let topicPhrase = topics.length > 0 ? 
    `about ${topics.join(" and ")}` : 
    "on that topic";
  
  return `I don't have specific sermon content that addresses your question ${topicPhrase}. 

From the previous sermon content we discussed, the pastor focused more on the practical application rather than detailed explanations. Would you like me to suggest a different aspect of this topic that might be covered in the sermons? Or perhaps you could rephrase your question to focus on a specific biblical passage or practical application?`;
}

/**
 * Generate a response that follows up on previous content
 */
function generateFollowUpResponse(query, conversationHistory, queryTopics) {
  // Get topic from query or from previous conversation
  const topicPhrase = queryTopics.length > 0 ? 
    queryTopics.join(" and ") : 
    "that specific aspect";
  
  return `I couldn't find sermon content that specifically addresses ${topicPhrase} in relation to your follow-up question. 

The pastor may have covered this in other sermons not in our current database. Would you like me to help you explore a related topic that is covered in the sermons? For example, I could search for sermon content about the biblical foundations or practical applications related to this topic.`;
}

/**
 * Generate a response suggesting related topics
 */
function generateRelatedTopicsResponse(query, queryTopics, previousSermonTopics) {
  // Combine query topics with previous topics, removing duplicates
  const allTopics = [...new Set([...queryTopics, ...previousSermonTopics])];
  
  // Generate related topics based on current topics
  const relatedTopics = generateRelatedTopics(allTopics);
  
  // Create a list of suggested search terms
  const suggestedSearches = relatedTopics.map(topic => {
    if (queryTopics.length > 0) {
      return `"${queryTopics[0]} and ${topic}"`;
    } else {
      return `"${topic}"`;
    }
  });
  
  // Format the suggested searches
  const suggestionsText = suggestedSearches.length > 0 ? 
    `You might want to try searching for:\n- ${suggestedSearches.join("\n- ")}` : 
    "You might want to try rephrasing your question to focus on specific biblical teachings or practical applications.";
  
  return `I couldn't find sermon content that directly addresses your question about ${queryTopics.join(" and ")}. 

The pastor may have discussed this in other sermons or from a different perspective than how you phrased your question. ${suggestionsText}

Would you like me to search for any of these related topics?`;
}

/**
 * Generate a response suggesting search refinement
 */
function generateSearchRefinementResponse(query) {
  return `I couldn't find sermon content that directly answers your question. The pastor may have addressed this topic using different terminology or approached it from a different angle.

To help me find relevant sermon content, you could:
- Try using more specific biblical terms
- Mention a Bible passage you're interested in
- Ask about practical application of a spiritual principle
- Focus on a specific aspect of Christian living

Would you like me to help you rephrase your question?`;
}

/**
 * Generate a generic fallback response when other strategies don't apply
 */
function generateGenericFallbackResponse(query) {
  return `I don't have sermon content that directly addresses your question. However, I'd be happy to help you explore other topics from the pastor's teachings.

Here are some topics that are well-covered in the sermon database:
- Prayer and communication with God
- Faith and trust in difficult times
- Biblical interpretation and understanding
- Practical Christian living

Would you like me to search for sermon content on any of these topics instead?`;
}

/**
 * Generate related topics based on given topics
 */
 function generateRelatedTopics(topics) {
    // Topic relationships - what topics are commonly related to others
    const topicRelationships = {
      "prayer": ["faith", "spiritual disciplines", "hearing from God"],
      "faith": ["trust", "doubt", "spiritual growth"],
      "forgiveness": ["reconciliation", "healing", "relationships"],
      "relationships": ["family", "marriage", "community"],
      "biblical interpretation": ["theology", "hermeneutics", "Bible study"],
      "spiritual growth": ["discipleship", "maturity", "sanctification"]
      // Add more relationships as needed
    };
    
    const relatedTopics = [];
    
    // Find related topics based on the topic relationships
    topics.forEach(topic => {
      if (topicRelationships[topic]) {
        topicRelationships[topic].forEach(relatedTopic => {
          if (!topics.includes(relatedTopic) && !relatedTopics.includes(relatedTopic)) {
            relatedTopics.push(relatedTopic);
          }
        });
      }
    });
    
    // If we still don't have enough related topics, add some general ones
    if (relatedTopics.length < 3) {
      const generalTopics = ["prayer", "faith", "biblical teaching", "spiritual growth"];
      generalTopics.forEach(topic => {
        if (!topics.includes(topic) && !relatedTopics.includes(topic)) {
          relatedTopics.push(topic);
        }
      });
    }
    
    // Return at most 3 related topics
    return relatedTopics.slice(0, 3);
  }
/**
 * Display the answer and sources from the API - With conversation fallback
 */
function displayAnswer(data) {
  if (!data || !data.answer) {
    console.error('Invalid data received from API');
    addMessage("Sorry, I received an invalid response from the API. Please try again.", 'bot');
    return;
  }
  
  // Check if there are any sermon sources
  const hasSermonContent = data.sources && data.sources.length > 0;
  
  // If no sermon content was found but we have conversation history
  if (!hasSermonContent && data.answer.includes(translate('no-results')) && conversationHistory.length > 0) {
    
    // Generate a conversational response instead
    const conversationalResponse = handleConversationFallback(
      data.query, 
      conversationHistory
    );
    
    // Display the conversational response
    const messageElement = addMessage(conversationalResponse, 'bot');
    messageElement.classList.add('conversation-mode'); // Add this class to style conversation mode differently if desired
    
    // Add to conversation history
    conversationHistory.push({ 
      role: 'assistant', 
      content: conversationalResponse 
    });
    
    return;
  }
  
  // Regular processing for when sermon content is found
  const messageElement = addMessage(data.answer, 'bot');
  
      // Display sources if available
      if (hasSermonContent) {
        try {
          // Sort sources by similarity score
          const sortedSources = [...data.sources].sort((a, b) => b.similarity - a.similarity);
          
          // Create a sources container
          const sourcesContainer = document.createElement('div');
          sourcesContainer.className = 'sources-container';
          
          // Create tabbed interface structure
          sourcesContainer.innerHTML = `
            <div class="sources-tabs">
              <div class="source-tab active">Overview <span class="sources-count">${sortedSources.length}</span></div>
              <div class="source-tab">Details</div>
              <div class="source-tab">Transcript</div>
            </div>
            <div class="tab-content sources-overview active">
              <!-- Source cards go here -->
            </div>
            <div class="tab-content source-detail">
              <!-- Detailed source view -->
            </div>
            <div class="tab-content transcript-content">
              <!-- Transcript view -->
            </div>
          `;
          
          // Add sources container after the answer
          if (messageElement && messageElement.parentNode) {
            messageElement.parentNode.insertBefore(sourcesContainer, messageElement.nextSibling);
          } else {
            console.warn('Could not find messageElement parent for sources, adding to messages container');
            messagesContainer.appendChild(sourcesContainer);
          }
          
          // Get the sources overview tab content
          const sourcesOverview = sourcesContainer.querySelector('.sources-overview');
          
          // Add tab switching functionality
          const tabs = sourcesContainer.querySelectorAll('.source-tab');
          const tabContents = sourcesContainer.querySelectorAll('.tab-content');
          
          tabs.forEach((tab, index) => {
            tab.addEventListener('click', function() {
              // Remove active class from all tabs and contents
              tabs.forEach(t => t.classList.remove('active'));
              tabContents.forEach(c => c.classList.remove('active'));
              
              // Add active class to clicked tab and corresponding content
              this.classList.add('active');
              tabContents[index].classList.add('active');
            });
          });
          
          // Display top sources in the overview tab
          const sourceLimit = Math.min(sortedSources.length, 3); // Limit to top 3 sources
          const topSources = sortedSources.slice(0, sourceLimit);
          
          // Add sources to the overview tab
          topSources.forEach((source, index) => {
            const sourceElement = createSourceElement(source, index);
            sourcesOverview.appendChild(sourceElement);
          });
          
          // If there are more sources, add a "View all sources" button
          if (sortedSources.length > sourceLimit) {
            const viewAllButton = document.createElement('button');
            viewAllButton.className = 'view-all-sources';
            viewAllButton.textContent = `${translate('view-all-sources')} (${sortedSources.length})`;
            viewAllButton.addEventListener('click', function() {
              // Clear existing sources
              sourcesOverview.innerHTML = '';
              
              // Add all sources
              sortedSources.forEach((source, index) => {
                const sourceElement = createSourceElement(source, index);
                sourcesOverview.appendChild(sourceElement);
              });
              
              // Remove self
              this.remove();
            });
            
            sourcesOverview.appendChild(viewAllButton);
          }
      
      // Add a "continue conversation" hint if this is the first answer
      if (conversationHistory.length <= 2) {
        const continueHint = document.createElement('div');
        continueHint.className = 'continue-hint';
        continueHint.innerHTML = `<p><em>${translate('continue-conversation')}</em></p>`;
        messagesContainer.appendChild(continueHint);
      }
      
      // Add to conversation history
      conversationHistory.push({ role: 'assistant', content: data.answer });
      
    } catch (error) {
      console.error('Error displaying sources:', error);
      // Continue without displaying sources
      
      // Still add to conversation history
      conversationHistory.push({ role: 'assistant', content: data.answer });
    }
  }
}

/**
 * Create a source element with translated UI
 */
/**
 * Format a date string from various possible formats
 */
 function formatSermonDate(dateStr) {
    if (!dateStr) return 'Date unknown';
    
    try {
      // Handle YYYYMMDD format (common in the metadata)
      if (typeof dateStr === 'number' || (typeof dateStr === 'string' && /^\d{8}$/.test(dateStr))) {
        const yearStr = String(dateStr).substring(0, 4);
        const monthStr = String(dateStr).substring(4, 6);
        const dayStr = String(dateStr).substring(6, 8);
        
        const year = parseInt(yearStr);
        const month = parseInt(monthStr) - 1; // JavaScript months are 0-indexed
        const day = parseInt(dayStr);
        
        const date = new Date(year, month, day);
        
        // Verify the date is valid
        if (isNaN(date.getTime())) {
          return 'Date unknown';
        }
        
        return new Intl.DateTimeFormat(currentLanguage, {
          year: 'numeric',
          month: 'long', 
          day: 'numeric'
        }).format(date);
      }
      
      // Handle ISO date strings (YYYY-MM-DD)
      if (typeof dateStr === 'string' && dateStr.includes('-')) {
        const date = new Date(dateStr);
        
        // Verify the date is valid
        if (isNaN(date.getTime())) {
          return 'Date unknown';
        }
        
        return new Intl.DateTimeFormat(currentLanguage, {
          year: 'numeric',
          month: 'long', 
          day: 'numeric'
        }).format(date);
      }
      
      // Handle timestamp (milliseconds since epoch)
      if (typeof dateStr === 'number') {
        const date = new Date(dateStr);
        
        // Verify the date is valid
        if (isNaN(date.getTime())) {
          return 'Date unknown';
        }
        
        return new Intl.DateTimeFormat(currentLanguage, {
          year: 'numeric',
          month: 'long', 
          day: 'numeric'
        }).format(date);
      }
      
      // For any other format, try a direct Date parsing as last resort
      const date = new Date(dateStr);
      if (!isNaN(date.getTime())) {
        return new Intl.DateTimeFormat(currentLanguage, {
          year: 'numeric',
          month: 'long', 
          day: 'numeric'
        }).format(date);
      }
      
      // Return as is if we can't parse it
      return typeof dateStr === 'string' ? dateStr : 'Date unknown';
    } catch (e) {
      console.error(`Error parsing date: ${dateStr}`, e);
      return 'Date unknown';
    }
  }
  
  /**
   * Create a source element with translated UI and properly formatted date
   */
  function createSourceElement(source, index) {
    const sourceElement = document.createElement('div');
    sourceElement.className = 'source-container';
    sourceElement.setAttribute('data-video-id', source.video_id);
    
    const similarity = Math.round(source.similarity * 100);
    const videoUrl = `https://www.youtube.com/embed/${source.video_id}?start=${Math.floor(source.start_time)}`;
    
    // Format title and date for display
    const formattedTitle = formatSermonTitle(source.title);
    
    // Handle date formatting properly
    let formattedDate = 'Date unknown';
    if (source.publish_date) {
      formattedDate = formatSermonDate(source.publish_date);
    }
    
    // Create collapsed view first (default)
    sourceElement.innerHTML = `
      <div class="source-header">
        <div class="source-title">${escapeHTML(formattedTitle)}</div>
        <div class="source-date">${formattedDate}</div>
      </div>
      <div class="source-text">"${formatText(source.text.substring(0, 150))}${source.text.length > 150 ? '...' : ''}"</div>
      <div class="source-meta">
        <span class="source-time">Timestamp: ${formatTimestamp(source.start_time)}</span>
        <span class="source-match">${similarity}% match</span>
      </div>
      <div class="source-actions">
        <button class="watch-video-btn" onclick="toggleVideo(this)">${translate('watch-video')}</button>
        <button class="view-transcript-btn" onclick="toggleTranscript('${source.video_id}', ${source.start_time})">${translate('view-transcript')}</button>
        <a href="https://www.youtube.com/watch?v=${source.video_id}&t=${Math.floor(source.start_time)}" target="_blank" class="open-youtube-btn">
          ${translate('open-youtube')}
        </a>
      </div>
      <div class="video-embed" style="display: none;">
        <iframe src="${videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen height="215"></iframe>
      </div>
    `;
    
    return sourceElement;
  }
  
  /**
   * Download transcript as a text file with proper sermon title
   */
  function downloadTranscript(videoId, segments) {
      if (!segments || !segments.length) return;
      
      // Try to find the sermon title
      const sourceContainer = document.querySelector(`.source-container[data-video-id="${videoId}"]`);
      let sermonTitle = "Unknown Sermon";
      
      if (sourceContainer) {
          const titleElement = sourceContainer.querySelector('.source-title');
          if (titleElement) {
              sermonTitle = titleElement.textContent.trim();
          }
      }
      
      // Create the text content with proper title
      let textContent = `${sermonTitle} (ID: ${videoId})\n\n`;
      
      segments.forEach(segment => {
        if (segment.is_gap) {
          textContent += '[...]\n\n';
        } else {
          textContent += `[${formatTimestamp(segment.start_time)}] ${segment.text}\n\n`;
        }
      });
      
      // Create a blob with the text content
      const blob = new Blob([textContent], { type: 'text/plain' });
      
      // Create an object URL for the blob
      const url = URL.createObjectURL(blob);
      
      // Create a temporary link element
      const a = document.createElement('a');
      a.href = url;
      a.download = `${sermonTitle.replace(/[^\w\s-]/g, '')}-transcript.txt`;
      
      // Append the link to the body, click it, and then remove it
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
  }

/**
 * Handle form submission - FIXED VERSION
 */
async function handleSubmit(event) {
  event.preventDefault();
  console.log('Form submitted');
  
  const query = queryInput.value.trim();
  if (!query) {
    console.log('Empty query, ignoring');
    return;
  }
  
  // Add user message to the chat
  addMessage(query, 'user');
  
  // Add to conversation history
  conversationHistory.push({ role: 'user', content: query });
  
  // Limit history length
  if (conversationHistory.length > MAX_MEMORY_LENGTH * 2) {
    conversationHistory = conversationHistory.slice(-MAX_MEMORY_LENGTH * 2);
  }
  
  // Clear input field
  queryInput.value = '';
  
  // Add typing indicator
  const typingId = addTypingIndicator();
  
  try {
    // Check API connection first
    const isConnected = await verifyApiConnection(false);
    
    if (!isConnected) {
      removeMessage(typingId);
      addMessage(`
        <div class="connection-error">
          <p>${translate('connection-error')}</p>
          <button class="retry-button">${translate('retry')}</button>
        </div>
      `, 'bot', true);
      
      // Add click handler for retry button
      document.querySelector('.retry-button').addEventListener('click', function() {
        verifyApiConnection(true);
      });
      
      return;
    }
    
    // Send request to API with conversation history for context
    const url = `${API_URL}/answer`;
    console.log('Sending request to:', url);
    
    // Create API request payload with language
    const payload = {
      query: query,
      top_k: 5,
      include_sources: true,
      language: currentLanguage // Send language preference to API
    };
    
    // Add conversation history if available
    if (conversationHistory.length > 1) {
      payload.conversation_history = conversationHistory.slice(0, -1); // Exclude current query
    }
    
    // Send language in both header and payload
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Origin': window.location.origin,
        'Accept-Language': currentLanguage // Language header
      },
      mode: 'cors',
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      console.error('API Error:', response.status, response.statusText);
      throw new Error(`API request failed with status ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Received response:', data);
    
    // Remove typing indicator
    removeMessage(typingId);
    
    // Display AI response (with conversation fallback if needed)
    displayAnswer(data);
    
    // Check if there was a previous message to connect this one with
    const messages = messagesContainer.querySelectorAll('.message.bot:not(.typing-indicator)');
    if (messages.length > 1) {
      // Mark the previous bot message as having a follow-up
      messages[messages.length - 2].classList.add('followed-up');
    }
    
  } catch (error) {
    console.error('Error:', error);
    
    // Remove typing indicator
    removeMessage(typingId);
    
    // Show error message with retry option
    addMessage(`
      <div class="error-container">
        <p>Sorry, there was an error processing your question (${error.message}).</p>
        <button class="retry-button">${translate('try-again')}</button>
      </div>
    `, 'bot', true);
    
    // Add click handler for retry button
    document.querySelector('.retry-button').addEventListener('click', function() {
      // Put the query back in the input
      queryInput.value = query;
      // Focus the input
      queryInput.focus();
    });
  }
}

/**
 * Toggle video display
 */
function toggleVideo(button) {
  try {
    if (!button || !button.parentElement) {
      console.error('Invalid button element for toggleVideo');
      return;
    }
    
    const videoEmbed = button.parentElement.nextElementSibling;
    if (!videoEmbed || !videoEmbed.classList.contains('video-embed')) {
      console.error('Could not find video embed element');
      return;
    }
    
    const isHidden = videoEmbed.style.display === 'none';
    
    // Toggle the video display
    videoEmbed.style.display = isHidden ? 'block' : 'none';
    
    // Update the button text safely
    const hideText = typeof translate === 'function' ? translate('hide-video') : 'Hide Video';
    const showText = typeof translate === 'function' ? translate('watch-video') : 'Watch Video';
    button.textContent = isHidden ? hideText : showText;
    
    // Scroll to make video visible if showing
    if (isHidden) {
      setTimeout(() => {
        videoEmbed.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
  } catch (error) {
    console.error('Error in toggleVideo:', error);
  }
}

/**
 * Escape HTML for safety
 */
function escapeHTML(str) {
  if (!str) return '';
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

/**
 * Format text (e.g., highlight Bible references)
 */
function formatText(text) {
  if (!text) return '';
  // First escape HTML
  text = escapeHTML(text);
  // Then highlight Bible references
  return highlightBibleReferences(text);
}

/**
 * Highlight Bible references in text
 */
function highlightBibleReferences(text) {
  // Use the appropriate regex based on current language
  const regex = getBibleReferenceRegexForLanguage();
  
  return text.replace(regex, '<span class="bible-reference">$&</span>');
}

/**
 * Fetch and display a sermon transcript with translation
 */
async function fetchTranscript(videoId, startTime = 0) {
  try {
    // Show loading state
    const loadingElement = document.createElement('div');
    loadingElement.className = 'transcript-loading';
    loadingElement.textContent = translate('loading-transcript');
    
    // Find or create the transcript container for this source
    let transcriptContainer = document.getElementById(`transcript-${videoId}`);
    
    if (!transcriptContainer) {
      // If no container exists yet, create one
      transcriptContainer = document.createElement('div');
      transcriptContainer.id = `transcript-${videoId}`;
      transcriptContainer.className = 'transcript-container';
      transcriptContainer.style.display = 'block';
      
      // Find the source container to append to
      const sourceContainer = document.querySelector(`.source-container[data-video-id="${videoId}"]`);
      if (sourceContainer) {
        sourceContainer.appendChild(transcriptContainer);
      } else {
        console.error('Could not find source container for video ID:', videoId);
        return;
      }
    }
    
    // Clear and show loading
    transcriptContainer.innerHTML = '';
    transcriptContainer.appendChild(loadingElement);
    
    console.log(`Fetching transcript for video ${videoId} with language ${currentLanguage}`);
    
    // Fetch the transcript from the API
    const response = await fetch(`${API_URL}/transcript/${videoId}?language=${currentLanguage}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Origin': window.location.origin,
        'Accept-Language': currentLanguage
      },
      mode: 'cors'
    });
    
    if (!response.ok) {
      throw new Error(`Failed to fetch transcript: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Received transcript data:', data);
    
    // Remove loading element
    loadingElement.remove();
    
    // Create transcript content
    const transcriptContent = document.createElement('div');
    transcriptContent.className = 'transcript-content';
    
    // If there's a note (like language unavailability), display it
    if (data.note) {
      const noteElement = document.createElement('div');
      noteElement.className = 'transcript-note';
      noteElement.innerHTML = `<p><em>${data.note}</em></p>`;
      transcriptContainer.appendChild(noteElement);
    }
    
    // Add search functionality
    const searchContainer = document.createElement('div');
    searchContainer.className = 'transcript-search';
    searchContainer.innerHTML = `
      <input type="text" placeholder="Search in transcript..." class="transcript-search-input">
      <button class="transcript-search-button">Search</button>
    `;
    
    // Add event listeners for search
    const searchInput = searchContainer.querySelector('.transcript-search-input');
    const searchButton = searchContainer.querySelector('.transcript-search-button');
    
    searchButton.addEventListener('click', () => {
      searchTranscript(searchInput.value, transcriptContent);
    });
    
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchTranscript(searchInput.value, transcriptContent);
      }
    });
    
    // Add download transcript option
    const downloadButton = document.createElement('button');
    downloadButton.className = 'transcript-download-button';
    downloadButton.textContent = 'Download Transcript';
    downloadButton.addEventListener('click', () => {
      downloadTranscript(videoId, data.segments);
    });
    searchContainer.appendChild(downloadButton);
    
    // If the API returns segments with timestamps
    if (data.segments && Array.isArray(data.segments)) {
      // Add transcript info
      const infoElement = document.createElement('div');
      infoElement.className = 'transcript-info';
      infoElement.innerHTML = `<p>Full transcript (${data.total_segments} segments)</p>`;
      transcriptContainer.appendChild(infoElement);
      
      // Handle segmented transcript with timestamps
      data.segments.forEach(segment => {
        const segmentElement = document.createElement('div');
        
        // Check if this is a gap segment
        if (segment.is_gap) {
          segmentElement.className = 'transcript-gap';
          segmentElement.innerHTML = '<span class="transcript-gap-indicator">[...]</span>';
          transcriptContent.appendChild(segmentElement);
          return;
        }
        
        segmentElement.className = 'transcript-segment';
        
        const timestampElement = document.createElement('span');
        timestampElement.className = 'transcript-timestamp';
        timestampElement.textContent = formatTimestamp(segment.start_time);
        
        const textElement = document.createElement('span');
        textElement.className = 'transcript-text';
        textElement.textContent = segment.text;
        
        // Apply highlighting to this segment if it contains our search terms
        segmentElement.setAttribute('data-time', segment.start_time);
        
        // Highlight the segment closest to our start time
        if (Math.abs(segment.start_time - startTime) < 10) {
          segmentElement.classList.add('transcript-highlight-segment');
        }
        
        segmentElement.appendChild(timestampElement);
        segmentElement.appendChild(textElement);
        transcriptContent.appendChild(segmentElement);
      });
    } else if (data.transcript) {
      // Handle plain text transcript (fallback)
      transcriptContent.innerHTML = data.transcript
        .split('\n\n') // Split paragraphs
        .map(para => `<p>${para}</p>`)
        .join('');
    } else {
      // Fallback for unexpected format
      transcriptContent.innerHTML = '<p>Transcript is available but in an unexpected format. Please try again later.</p>';
    }
    
    // Add timestamp navigation helper
    const timestampHelper = document.createElement('div');
    timestampHelper.className = 'transcript-timestamp-helper';
    timestampHelper.innerHTML = `
      <small>Click on timestamps to jump to that part of the sermon</small>
    `;
    
    // Add content to container
    transcriptContainer.appendChild(searchContainer);
    transcriptContainer.appendChild(timestampHelper);
    transcriptContainer.appendChild(transcriptContent);
    
    // Add timestamp click handling
    const timestamps = transcriptContainer.querySelectorAll('.transcript-timestamp');
    timestamps.forEach(timestamp => {
      timestamp.style.cursor = 'pointer';
      timestamp.setAttribute('title', 'Click to jump to this part of the sermon');
      
      timestamp.addEventListener('click', function() {
        const segment = this.closest('.transcript-segment');
        if (segment) {
          const time = segment.getAttribute('data-time');
          if (time) {
            // Find the YouTube embed and update its time
            const sourceContainer = transcriptContainer.closest('.source-container');
            if (sourceContainer) {
              // Make sure video is visible
              const videoEmbed = sourceContainer.querySelector('.video-embed');
              const watchButton = sourceContainer.querySelector('.watch-video-btn');
              
              if (videoEmbed && videoEmbed.style.display === 'none') {
                // Show the video if it's hidden
                videoEmbed.style.display = 'block';
                if (watchButton) {
                  watchButton.textContent = translate('hide-video');
                }
              }
              
              // Update iframe src to jump to timestamp
              const iframe = sourceContainer.querySelector('iframe');
              if (iframe) {
                const currentSrc = iframe.src;
                const baseUrl = currentSrc.split('?')[0];
                iframe.src = `${baseUrl}?start=${Math.floor(time)}`;
                
                // Scroll to make video visible
                videoEmbed.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }
            }
          }
        }
      });
    });
    
    // Scroll to highlighted segment if it exists
    const highlightedSegment = transcriptContainer.querySelector('.transcript-highlight-segment');
    if (highlightedSegment) {
      setTimeout(() => {
        highlightedSegment.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }
    
  } catch (error) {
    console.error('Error fetching transcript:', error);
    
    // Show error in container
    const errorElement = document.createElement('div');
    errorElement.className = 'transcript-error';
    errorElement.textContent = `Could not load transcript: ${error.message}`;
    
    // Find the transcript container
    let transcriptContainer = document.getElementById(`transcript-${videoId}`);
    
    if (!transcriptContainer) {
      // If no container exists yet, create one
      transcriptContainer = document.createElement('div');
      transcriptContainer.id = `transcript-${videoId}`;
      transcriptContainer.className = 'transcript-container';
      
      // Find the source container to append to
      const sourceContainer = document.querySelector(`.source-container[data-video-id="${videoId}"]`);
      if (sourceContainer) {
        sourceContainer.appendChild(transcriptContainer);
      } else {
        console.error('Could not find source container for video ID:', videoId);
        return;
      }
    }
    
    transcriptContainer.innerHTML = '';
    transcriptContainer.appendChild(errorElement);
    
    // Add retry button
    const retryButton = document.createElement('button');
    retryButton.className = 'retry-button';
    retryButton.textContent = translate('retry');
    retryButton.onclick = () => fetchTranscript(videoId, startTime);
    transcriptContainer.appendChild(retryButton);
  }
}

/**
 * Download transcript as a text file with proper sermon title
 */
function downloadTranscript(videoId, segments) {
    if (!segments || !segments.length) return;
    
    // Try to find the sermon title
    const sourceContainer = document.querySelector(`.source-container[data-video-id="${videoId}"]`);
    let sermonTitle = "Unknown Sermon";
    
    if (sourceContainer) {
        const titleElement = sourceContainer.querySelector('.source-title');
        if (titleElement) {
            sermonTitle = titleElement.textContent.trim();
        }
    }
    
    // Create the text content with proper title
    let textContent = `${sermonTitle} (ID: ${videoId})\n\n`;
    
    segments.forEach(segment => {
      if (segment.is_gap) {
        textContent += '[...]\n\n';
      } else {
        textContent += `[${formatTimestamp(segment.start_time)}] ${segment.text}\n\n`;
      }
    });
    
    // Create a blob with the text content
    const blob = new Blob([textContent], { type: 'text/plain' });
    
    // Create an object URL for the blob
    const url = URL.createObjectURL(blob);
    
    // Create a temporary link element
    const a = document.createElement('a');
    a.href = url;
    a.download = `${sermonTitle.replace(/[^\w\s-]/g, '')}-transcript.txt`;
    
    // Append the link to the body, click it, and then remove it
    document.body.appendChild(a);
    a.click();
    
    // Clean up
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
}

// Add these styles to make gaps visible
function addImprovedTranscriptStyles() {
    const styleElement = document.createElement('style');
    styleElement.textContent = `
      .transcript-gap {
        padding: 8px 4px;
        text-align: center;
        color: #888;
        font-style: italic;
      }
      
      .transcript-gap-indicator {
        display: inline-block;
        background-color: rgba(0,0,0,0.05);
        padding: 2px 8px;
        border-radius: 4px;
      }
      
      .transcript-download-button {
        margin-left: auto;
        padding: 6px 12px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
      }
      
      .transcript-download-button:hover {
        background-color: #e9ecef;
      }
    `;
    
    document.head.appendChild(styleElement);
}

// Call this function during page initialization
document.addEventListener('DOMContentLoaded', function() {
    // Add to your existing initialization
    addImprovedTranscriptStyles();
});

/**
 * Search within a transcript and highlight matches
 */
function searchTranscript(query, transcriptContent) {
  if (!query || !transcriptContent) return;
  
  // Remove existing highlights
  const existingHighlights = transcriptContent.querySelectorAll('.transcript-highlight');
  existingHighlights.forEach(el => {
    const parent = el.parentNode;
    parent.replaceChild(document.createTextNode(el.textContent), el);
    // Normalize to combine adjacent text nodes
    parent.normalize();
  });
  
  if (!query.trim()) return;
  
  // Function to highlight matches in a text node
  function highlightMatches(textNode, regex) {
    const parent = textNode.parentNode;
    const content = textNode.textContent;
    
    let match;
    let lastIndex = 0;
    let hasMatches = false;
    
    // Create a document fragment to hold the new content
    const fragment = document.createDocumentFragment();
    
    // Find all matches in this text node
    while ((match = regex.exec(content)) !== null) {
      hasMatches = true;
      
      // Add the text up to this match
      if (match.index > lastIndex) {
        fragment.appendChild(document.createTextNode(
          content.substring(lastIndex, match.index)
        ));
      }
      
      // Create a highlight span for the match
      const highlightSpan = document.createElement('span');
      highlightSpan.className = 'transcript-highlight';
      highlightSpan.textContent = match[0];
      fragment.appendChild(highlightSpan);
      
      // Update lastIndex
      lastIndex = regex.lastIndex;
    }
    
    // Add any remaining text
    if (lastIndex < content.length) {
      fragment.appendChild(document.createTextNode(
        content.substring(lastIndex)
      ));
    }
    
    // Only replace if we found matches
    if (hasMatches) {
      parent.replaceChild(fragment, textNode);
      return true;
    }
    
    return false;
  }
  
  // Create a case-insensitive regex for the search term
  const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
  
  // Process all text nodes in the transcript
  const walker = document.createTreeWalker(
    transcriptContent,
    NodeFilter.SHOW_TEXT,
    null,
    false
  );
  
  let node;
  let matchCount = 0;
  
  while (node = walker.nextNode()) {
    if (highlightMatches(node, regex)) {
      matchCount++;
    }
  }
  
  // Scroll to first highlight if any found
  const firstHighlight = transcriptContent.querySelector('.transcript-highlight');
  if (firstHighlight) {
    firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  // Show match count
  const matchCountElement = document.createElement('div');
  matchCountElement.className = 'transcript-match-count';
  matchCountElement.textContent = matchCount > 0 
    ? `Found ${matchCount} matches` 
    : 'No matches found';
  
  // Replace existing count or add new one
  const existingCount = transcriptContent.parentNode.querySelector('.transcript-match-count');
  if (existingCount) {
    existingCount.replaceWith(matchCountElement);
  } else {
    transcriptContent.parentNode.insertBefore(matchCountElement, transcriptContent);
  }
}

/**
 * Toggle transcript visibility and load if needed
 */
function toggleTranscript(videoId, startTime = 0) {
  try {
    if (!videoId) {
      console.error('Invalid videoId for toggleTranscript');
      return;
    }
    
    const transcriptContainer = document.getElementById(`transcript-${videoId}`);
    const button = document.querySelector(`.view-transcript-btn[onclick*="toggleTranscript('${videoId}')"]`);
    
    if (!transcriptContainer) {
      // Transcript hasn't been loaded yet, fetch it
      fetchTranscript(videoId, startTime);
      // Update button text if found
      if (button) {
        button.textContent = typeof translate === 'function' ? 
          translate('hide-transcript') : 'Hide Transcript';
      }
      return;
    }
    
    // Toggle visibility
    const isHidden = transcriptContainer.style.display === 'none';
    transcriptContainer.style.display = isHidden ? 'block' : 'none';
    
    // Update button text
    if (button) {
      const hideText = typeof translate === 'function' ? translate('hide-transcript') : 'Hide Transcript';
      const showText = typeof translate === 'function' ? translate('view-transcript') : 'View Transcript';
      button.textContent = isHidden ? hideText : showText;
    }
    
    // Scroll into view if showing
    if (isHidden) {
      setTimeout(() => {
        transcriptContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
  } catch (error) {
    console.error('Error in toggleTranscript:', error);
  }
}

// Make global functions available to be called from HTML
window.toggleVideo = toggleVideo;
window.toggleTranscript = toggleTranscript;

// Tab switching functionality
document.querySelectorAll('.source-tab').forEach((tab, index) => {
  tab.addEventListener('click', function() {
    // Remove active class from all tabs and content
    document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding content
    this.classList.add('active');
    document.querySelectorAll('.tab-content')[index].classList.add('active');
  });
});
</script>
